---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Container from '../../components/layout/Container.astro';
import Badge from '../../components/ui/Badge.astro';
import { formatDate } from '../../lib/blog';
import { config } from '../../config';
import { isSectionEnabled, DISABLED_SECTION_REDIRECT } from '../../lib/sections';

// Redirect if section is disabled
if (!isSectionEnabled('blog')) {
  return Astro.redirect(DISABLED_SECTION_REDIRECT);
}

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const title = `${post.data.title} | ${config.site.title}`;
---

<BaseLayout title={title} description={post.data.description}>
  <article class="blog-post">
    <Container size="narrow">
      <header class="post-header" data-animate="fade-up">
        <div class="post-meta">
          <time datetime={post.data.date.toISOString()}>
            {formatDate(post.data.date)}
          </time>
          {post.data.updated && (
            <span class="updated">
              Updated {formatDate(post.data.updated)}
            </span>
          )}
        </div>
        <h1>{post.data.title}</h1>
        {post.data.description && (
          <p class="post-description">{post.data.description}</p>
        )}
        {post.data.tags.length > 0 && (
          <div class="post-tags">
            {post.data.tags.map(tag => (
              <Badge size="sm">{tag}</Badge>
            ))}
          </div>
        )}
      </header>

      <div class="post-content prose" data-animate="fade-up">
        <Content />
      </div>

      <footer class="post-footer">
        <a href="/blog" class="back-link">&larr; Back to all posts</a>
      </footer>
    </Container>
  </article>
</BaseLayout>

<style>
  .blog-post {
    padding: var(--space-8) 0;
  }

  .post-header {
    margin-bottom: var(--space-10);
  }

  .post-meta {
    font-size: var(--font-size-sm);
    font-family: var(--font-mono);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
    display: flex;
    gap: var(--space-4);
  }

  .updated {
    color: var(--color-text-muted);
  }

  .post-header h1 {
    font-size: var(--font-size-3xl);
    margin-bottom: var(--space-4);
  }

  .post-description {
    font-size: var(--font-size-xl);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    margin-bottom: var(--space-4);
  }

  .post-tags {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  /* Prose styles for content */
  .prose {
    line-height: var(--line-height-relaxed);
  }

  .prose :global(h2) {
    margin-top: var(--space-10);
    margin-bottom: var(--space-4);
  }

  .prose :global(h3) {
    margin-top: var(--space-8);
    margin-bottom: var(--space-3);
  }

  .prose :global(p) {
    margin-bottom: var(--space-4);
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: var(--space-4);
    padding-left: var(--space-6);
  }

  .prose :global(li) {
    margin-bottom: var(--space-2);
  }

  .prose :global(pre) {
    margin: var(--space-6) 0;
  }

  .prose :global(blockquote) {
    margin: var(--space-6) 0;
    padding-left: var(--space-4);
    border-left: 3px solid var(--color-accent);
    font-style: italic;
    color: var(--color-text-secondary);
  }

  .prose :global(img) {
    margin: var(--space-6) 0;
    border-radius: var(--radius-md);
  }

  .post-footer {
    margin-top: var(--space-12);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border);
  }

  .back-link {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .back-link:hover {
    color: var(--color-accent);
  }
</style>
