---
/**
 * Blog Index Page
 * Uses the unified view system for consistent, customizable display
 */
export const prerender = false; // Server-render to support URL params for preview

import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { config } from '../../lib/config';
import ViewDispatcher from '../../components/views/ViewDispatcher.astro';
import PreviewPanel from '../../components/PreviewPanel.astro';
import { getPageOptions } from '../../lib/preview-options';

// Page configuration (inline)
const title = 'Blog';
const description = 'Thoughts on research, technology, and academia';
// Allow URL param to override view for preview mode
const urlView = Astro.url.searchParams.get('view');
const view = urlView || 'grid';
const viewConfig = { columns: 2, showImage: true, showTags: true, showDate: true };
const sortBy = 'date';
const sortOrder = 'desc';

// Get all blog posts, excluding drafts
const posts = await getCollection('blog', ({ data }) => !data.draft);

// Sort entries based on frontmatter config
const sortedEntries = posts.sort((a, b) => {
  const fieldA = (a.data as any)[sortBy || 'date'];
  const fieldB = (b.data as any)[sortBy || 'date'];

  const valA = fieldA?.valueOf?.() ?? fieldA ?? 0;
  const valB = fieldB?.valueOf?.() ?? fieldB ?? 0;

  return sortOrder === 'asc' ? valA - valB : valB - valA;
});

// Prepend base path to images
const base = import.meta.env.BASE_URL;

// Transform entries for view components
const viewItems = sortedEntries.map(entry => {
  let image = entry.data.image;
  if (image && !image.startsWith('http')) {
    image = base === '/' ? image : `${base}${image}`;
  }

  return {
    title: entry.data.title,
    slug: entry.slug,
    description: entry.data.description,
    date: entry.data.date,
    tags: entry.data.tags,
    image: image,
    imageAlt: entry.data.imageAlt,
    draft: entry.data.draft,
    type: 'blog' as const,
  };
});

const pageTitle = `${title} | ${config.site.title}`;
---

<BaseLayout title={pageTitle} description={description}>
  <article class="collection-page">
    <div class="container">
      <ViewDispatcher
        view={view || 'grid'}
        items={viewItems}
        config={viewConfig}
        collection="blog"
        title={title}
        description={description}
      />

      {viewItems.length === 0 && (
        <div class="empty-state" data-animate="fade-up">
          <p>No blog posts to display yet. Check back soon!</p>
        </div>
      )}
    </div>
  </article>
</BaseLayout>

<style>
  .collection-page {
    /* Vertical padding handled by article in global.css */
  }

  .empty-state {
    text-align: center;
    padding: var(--space-12) var(--space-4);
    color: var(--color-text-muted);
  }
</style>

{import.meta.env.DEV && (
  <PreviewPanel
    pageType="blog"
    options={getPageOptions('blog')?.options || []}
  />
)}

<script>
  document.addEventListener('preview-option-change', ((e: CustomEvent) => {
    const { option, value, pageType } = e.detail;
    if (pageType !== 'blog') return;

    // View/style changes are handled by PreviewPanel via URL params
    // Toggle options are handled via CSS data attributes
  }) as EventListener);
</script>
