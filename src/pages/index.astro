---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { PaperCard, ProjectCard, BlogCard } from '../components/blocks';
import { config } from '../config';
import educationData from '../content/education.json';

const title = config.site.title;

// Load selected publications from content collection
let selectedPublications: any[] = [];
if (config.features.selectedPublications) {
  try {
    const allPublications = await getCollection('publications');
    if (allPublications.length > 0) {
      selectedPublications = allPublications
        .filter(pub => pub.data.selected)
        .sort((a, b) => b.data.year - a.data.year);
    }
  } catch (e) {
    // Fallback to JSON if collection doesn't exist
    console.log('Using publications from JSON file');
  }
}

// Load featured projects from content collection
let featuredProjects: any[] = [];
if (config.features.selectedPublications) { // Using same feature flag as publications for now
  try {
    const allProjects = await getCollection('projects');
    if (allProjects.length > 0) {
      featuredProjects = allProjects
        .filter(proj => proj.data.featured)
        .slice(0, 3);
    }
  } catch (e) {
    console.log('No projects available');
  }
}

// Load recent blog posts from content collection
let recentPosts: any[] = [];
try {
  const allPosts = await getCollection('blog');
  if (allPosts.length > 0) {
    recentPosts = allPosts
      .filter(post => !post.data.draft)
      .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
      .slice(0, 3);
  }
} catch (e) {
  console.log('Blog collection not available');
}

// Education data
const education = educationData.education;

// Prepend base path to images
const base = import.meta.env.BASE_URL;
const prependBase = (path: string) => {
  if (!path || path.startsWith('http')) return path;
  return base === '/' ? path : `${base}${path}`;
};
---

<BaseLayout title={title}>
  <article class="about-page">
    <div class="container">
      <!-- About Section -->
      <section class="about-section" data-animate="fade-up">
        <p set:html={config.about.bio} />
        {config.about.affiliation && (
          <p>
            I am affiliated with <a href={config.about.affiliation.url}>{config.about.affiliation.name}</a>.
          </p>
        )}
      </section>

      <!-- Research Interests -->
      <section class="section" data-animate="fade-up">
        <h2>Research Interests</h2>
        <p set:html={config.about.researchInterests} />
      </section>

      <!-- Academic Background -->
      {config.features.education && education.length > 0 && (
        <section class="section" data-animate="fade-up">
          <h2>Academic Background</h2>

          <div class="education-list" data-animate="stagger">
            {education.map(edu => (
              <div class="education-item">
                <div class="education-period">{edu.startYear} â€“ {edu.endYear}</div>
                <div class="education-content">
                  <p><strong>{edu.degree} in {edu.field}</strong></p>
                  <p class="education-institution">
                    <a href={edu.institutionUrl}>{edu.institution}</a>
                  </p>
                  {edu.supervisors && (
                    <p class="education-details">
                      Supervisors: {edu.supervisors.map((sup, i) => (
                        <>
                          <a href={sup.url}>{sup.name}</a>
                          {i < edu.supervisors.length - 1 && ', '}
                        </>
                      ))}
                    </p>
                  )}
                  {edu.grade && (
                    <p class="education-details">Grade: {edu.grade}</p>
                  )}
                  {edu.thesis && (
                    <a href={edu.thesis.url} class="thesis-link">Thesis: {edu.thesis.title}</a>
                  )}
                </div>
              </div>
            ))}
          </div>
        </section>
      )}

      <!-- Selected Publications -->
      {config.features.selectedPublications && selectedPublications.length > 0 && (
        <section class="section" data-animate="fade-up">
          <h2>Selected Publications</h2>
          <div class="selected-papers" data-animate="stagger">
            {selectedPublications.map(pub => (
              <PaperCard
                title={pub.data.title}
                authors={pub.data.authors}
                venue={pub.data.venue || pub.data.journal || pub.data.booktitle}
                year={pub.data.year}
                preview={prependBase(pub.data.preview)}
                pdf={pub.data.pdf}
                html={pub.data.html}
                code={pub.data.code}
                abbr={pub.data.abbr}
              />
            ))}
          </div>
          <p class="view-all">
            <a href="/publications">View all publications &rarr;</a>
          </p>
        </section>
      )}

      <!-- Featured Projects -->
      {featuredProjects.length > 0 && (
        <section class="section" data-animate="fade-up">
          <h2>Featured Projects</h2>
          <div class="featured-projects" data-animate="stagger">
            {featuredProjects.map(project => {
              const data = project.data;
              return (
                <ProjectCard
                  title={data.title}
                  description={data.description}
                  technologies={data.technologies}
                  tags={data.tags}
                  github={data.github || data.url}
                  url={data.url}
                  demo={data.demo}
                  image={prependBase(data.image)}
                  status={data.status}
                />
              );
            })}
          </div>
          <p class="view-all">
            <a href="/projects">View all projects &rarr;</a>
          </p>
        </section>
      )}

      <!-- Recent Blog Posts -->
      {recentPosts.length > 0 && (
        <section class="section" data-animate="fade-up">
          <h2>Recent Posts</h2>
          <div class="recent-posts" data-animate="stagger">
            {recentPosts.map(post => (
              <BlogCard
                title={post.data.title}
                description={post.data.description}
                date={post.data.date}
                slug={post.slug}
                tags={post.data.tags}
                image={prependBase(post.data.image)}
              />
            ))}
          </div>
          <p class="view-all">
            <a href="/blog">View all posts &rarr;</a>
          </p>
        </section>
      )}
    </div>
  </article>
</BaseLayout>

<style>
  .about-page {
    /* Vertical padding handled by article in global.css */
  }

  /* About Section - first element alignment */
  .about-section {
    margin-top: 0;
    margin-bottom: var(--space-8);
  }

  .about-section p:first-child {
    margin-top: 0;
  }

  .about-section p {
    font-size: var(--font-size-base);
    font-family: var(--font-body);
    line-height: var(--line-height-normal);
  }

  /* Sections */
  .section {
    margin-bottom: var(--space-8);
  }

  .section h2 {
    margin-bottom: var(--space-4);
  }

  /* Selected Papers - uses global .paper-* classes from global.css */
  .selected-papers {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  /* Featured Projects */
  .featured-projects {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-4);
  }

  @media (max-width: 768px) {
    .featured-projects {
      grid-template-columns: 1fr;
    }
  }

  /* Recent Posts */
  .recent-posts {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  /* View all link */
  .view-all {
    margin-top: var(--space-4);
    text-align: right;
  }

  .view-all a {
    color: var(--color-accent);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    transition: opacity var(--transition-fast);
  }

  .view-all a:hover {
    opacity: 0.8;
  }

  /* Education */
  .education-list {
    display: flex;
    flex-direction: column;
  }

  .education-item {
    display: grid;
    grid-template-columns: 110px 1fr;
    gap: var(--space-5);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .education-item:hover {
    background-color: var(--color-bg-alt);
  }

  .education-period {
    font-size: var(--font-size-base);
    font-family: var(--font-body);
    font-weight: var(--font-weight-normal);
    line-height: var(--line-height-normal);
    color: var(--color-text-muted);
  }

  .education-content p {
    margin: 0 0 var(--space-1);
  }

  .education-content strong {
    font-weight: var(--font-weight-medium);
  }

  .education-institution a {
    color: var(--color-text-secondary);
  }

  .education-details {
    color: var(--color-text-muted);
  }

  .thesis-link {
    display: inline-block;
    font-size: var(--font-size-base);
    color: var(--color-accent);
    background: none;
  }

  @media (max-width: 500px) {
    .education-item {
      grid-template-columns: 1fr;
      gap: var(--space-1);
    }
  }
</style>
