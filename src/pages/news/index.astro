---
/**
 * News & Updates Index Page
 * Aggregates recent items from blog, talks, and publications
 * Uses the unified view system for consistent, customizable display
 */
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { config } from '../../lib/config';
import ViewDispatcher from '../../components/views/ViewDispatcher.astro';
import { loadPublications } from '../../lib/bibtex';
import path from 'node:path';
import PreviewPanel from '../../components/PreviewPanel.astro';
import { getPageOptions } from '../../lib/preview-options';

// Page configuration (inline - no external config file needed)
const title = 'News & Updates';
const description = 'Recent announcements, publications, and academic activities';
const view = 'timeline';
const viewConfig = { groupBy: 'year', showDate: true, dateFormat: 'short' };
const sortOrder = 'desc';

// Fetch blog posts
const blogPosts = await getCollection('blog', ({ data }) => !data.draft);

// Load publications from BibTeX
const contentDir = path.join(process.cwd(), 'src', 'content');
const publications = loadPublications(contentDir);

// Prepend base path to images
const base = import.meta.env.BASE_URL;

// Transform and combine all items into a unified format
const newsItems = [
  // Blog posts
  ...blogPosts.map(post => {
    let image = post.data.image;
    if (image && !image.startsWith('http')) {
      image = base === '/' ? image : `${base}${image}`;
    }
    return {
      type: 'blog' as const,
      date: post.data.date,
      title: post.data.title,
      description: post.data.description,
      slug: post.slug,
      tags: post.data.tags,
      image: image,
    };
  }),

  // Publications (limit to recent ones)
  ...publications.slice(0, 10).map(pub => ({
    type: 'publication' as const,
    date: new Date(pub.year, 0, 1), // Use January 1st of the year
    title: pub.title,
    description: pub.abstract,
    tags: pub.abbr ? [pub.abbr] : [],
    authors: pub.authors,
    venue: pub.journal || pub.booktitle,
    pdf: pub.pdf,
    code: pub.code,
  })),
];

// Sort by date (most recent first)
const sortedItems = newsItems.sort((a, b) => {
  const dateA = a.date.valueOf();
  const dateB = b.date.valueOf();
  return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
});

const pageTitle = `${title} | ${config.site.title}`;
---

<BaseLayout title={pageTitle} description={description}>
  <article class="collection-page">
    <div class="container">
      <ViewDispatcher
        view={view || 'timeline'}
        items={sortedItems}
        config={viewConfig}
        collection="news"
        title={title}
        description={description}
      />

      {sortedItems.length === 0 && (
        <div class="empty-state" data-animate="fade-up">
          <p>No news items to display yet. Check back soon!</p>
        </div>
      )}
    </div>
  </article>
</BaseLayout>

<style>
  .collection-page {
    /* Vertical padding handled by article in global.css */
  }

  .empty-state {
    text-align: center;
    padding: var(--space-12) var(--space-4);
    color: var(--color-text-muted);
  }
</style>

{import.meta.env.DEV && (
  <PreviewPanel
    pageType="news"
    options={getPageOptions('news')?.options || []}
  />
)}

<script>
  document.addEventListener('preview-option-change', ((e: CustomEvent) => {
    const { option, value, pageType } = e.detail;
    if (pageType !== 'news') return;

    // For view changes, we need to reload - show message
    if (option === 'view') {
      const existing = document.querySelector('.preview-reload-msg');
      if (existing) existing.remove();

      const msg = document.createElement('div');
      msg.className = 'preview-reload-msg';
      msg.innerHTML = `View changed to "${value}". <button onclick="location.reload()">Reload to apply</button>`;
      msg.style.cssText = 'position:fixed;bottom:80px;right:20px;background:var(--color-accent);color:white;padding:12px 16px;border-radius:8px;font-size:14px;z-index:9999;';
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 5000);
    }

    // Toggle date visibility
    if (option === 'showDate') {
      document.querySelectorAll('.view-date, time').forEach(el => {
        (el as HTMLElement).style.display = value ? '' : 'none';
      });
    }
  }) as EventListener);
</script>
