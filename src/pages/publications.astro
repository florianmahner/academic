---
import BaseLayout from '../layouts/BaseLayout.astro';
import { loadPublications, groupByYear } from '../lib/bibtex';
import { config } from '../config';
import path from 'node:path';

const title = `Publications | ${config.site.title}`;

// Load publications from BibTeX file
const contentDir = path.join(process.cwd(), 'src', 'content');
const publications = loadPublications(contentDir);

// Prepend base path to preview images
const base = import.meta.env.BASE_URL;
publications.forEach(pub => {
  if (pub.preview && !pub.preview.startsWith('http')) {
    pub.preview = base === '/' ? pub.preview : `${base}${pub.preview}`;
  }
});

// Group by year
const pubsByYear = groupByYear(publications);
const years = Object.keys(pubsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout title={title} description={`Academic publications by ${config.name.first} ${config.name.last}`}>
  <article class="publications-page">
    <div class="container">
      {years.map(year => (
        <section class="year-section" data-animate="fade-up">
          <h2 class="year-label">{year}</h2>
          <div class="publications-list" data-animate="stagger">
            {pubsByYear[Number(year)].map(pub => (
          <article class:list={['paper-card', pub.preview && 'paper-card--with-preview']}>
            {pub.preview ? (
              <div class="paper-preview">
                <img src={pub.preview} alt={pub.title} loading="lazy" class="preview-light" />
                <img src={pub.preview.replace('-light.gif', '-dark.gif')} alt={pub.title} loading="lazy" class="preview-dark" />
              </div>
            ) : (
              <div class="paper-preview">
                <svg viewBox="0 0 140 90" xmlns="http://www.w3.org/2000/svg" class="preview-placeholder">
                  <defs>
                    <linearGradient id={`grad-${pub.id}`} x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style={`stop-color:${pub.year % 2 === 0 ? '#e0e7ff' : '#fce7f3'};stop-opacity:1`} />
                      <stop offset="100%" style={`stop-color:${pub.year % 2 === 0 ? '#c7d2fe' : '#fbcfe8'};stop-opacity:1`} />
                    </linearGradient>
                  </defs>
                  <rect width="140" height="90" fill={`url(#grad-${pub.id})`} />
                  <text x="70" y="50" text-anchor="middle" font-size="24" font-weight="300" fill="#6b7280" opacity="0.6">{pub.year}</text>
                </svg>
              </div>
            )}
            <div class="paper-content">
              <div class="paper-meta">
                <span class="paper-venue">{pub.journal || pub.booktitle}</span>
              </div>
              <h3 class="paper-title">
                {pub.pdf ? (
                  <a href={pub.pdf} target="_blank" rel="noopener noreferrer">{pub.title}</a>
                ) : pub.html ? (
                  <a href={pub.html} target="_blank" rel="noopener noreferrer">{pub.title}</a>
                ) : (
                  pub.title
                )}
              </h3>
              <p class="paper-authors">
                {pub.authors.map((author, i) => (
                  <>
                    <span class:list={{ 'highlight-author': author.includes('Mahner') }}>
                      {author}
                    </span>
                    {i < pub.authors.length - 1 && ', '}
                  </>
                ))}
              </p>
              <div class="paper-links">
                {pub.pdf && (
                  <a href={pub.pdf} class="paper-link" target="_blank" rel="noopener noreferrer">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    PDF
                  </a>
                )}
                {pub.html && (
                  <a href={pub.html} class="paper-link" target="_blank" rel="noopener noreferrer">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="2" y1="12" x2="22" y2="12"></line>
                      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    Web
                  </a>
                )}
              </div>
            </div>
          </article>
            ))}
          </div>
        </section>
      ))}
    </div>
  </article>
</BaseLayout>

<style>
  .publications-page {
    /* Vertical padding handled by article in global.css */
  }

  .year-section {
    margin-bottom: var(--space-12);
  }

  .year-section:first-child {
    margin-top: 0;
  }

  .year-label {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-muted);
    margin-top: 0;
    margin-bottom: var(--space-4);
    font-family: var(--font-body);
  }

  /* Publications list - uses global .paper-* classes from global.css */
  .publications-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }
</style>
