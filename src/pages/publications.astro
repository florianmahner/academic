---
import BaseLayout from '../layouts/BaseLayout.astro';
import PublicationList from '../components/blocks/PublicationList.astro';
import { loadPublications } from '../lib/bibtex';
import { config } from '../lib/config';
import path from 'node:path';
import PreviewPanel from '../components/PreviewPanel.astro';
import { getPageOptions } from '../lib/preview-options';

const title = `Publications | ${config.site.title}`;

// Get publications config
const pubConfig = config.publications;

// Load publications from BibTeX file
const contentDir = path.join(process.cwd(), 'src', 'content');
const publications = loadPublications(contentDir);

// Prepend base path to preview images
const base = import.meta.env.BASE_URL;
publications.forEach(pub => {
  if (pub.preview && !pub.preview.startsWith('http')) {
    pub.preview = base === '/' ? pub.preview : `${base}${pub.preview}`;
  }
});
---

<BaseLayout title={title} description={`Academic publications by ${config.name.first} ${config.name.last}`}>
  <article class="publications-page">
    <div class="container">
      <header class="page-header" data-animate="fade-up">
        <h1>Publications</h1>
        <p class="page-description">
          Selected publications on machine learning, neuroscience, and AI.
        </p>
      </header>

      <PublicationList
        publications={publications}
        style={pubConfig.style}
        showPreviews={pubConfig.showPreviews}
        groupByYear={pubConfig.groupByYear}
        highlightAuthor={pubConfig.highlightAuthor || config.name.last}
      />
    </div>
  </article>
</BaseLayout>

{import.meta.env.DEV && (
  <PreviewPanel
    pageType="publications"
    options={getPageOptions('publications')?.options || []}
  />
)}

<script>
  document.addEventListener('preview-option-change', ((e: CustomEvent) => {
    const { option, value, pageType } = e.detail;
    if (pageType !== 'publications') return;

    // Handle style change
    if (option === 'style') {
      document.body.setAttribute('data-pub-style', value);
    }

    // Handle groupByYear
    if (option === 'groupByYear') {
      const yearHeaders = document.querySelectorAll('.year-header');
      yearHeaders.forEach(h => {
        (h as HTMLElement).style.display = value ? '' : 'none';
      });
    }

    // Handle showPreviews
    if (option === 'showPreviews') {
      const previews = document.querySelectorAll('.media-card-image');
      previews.forEach(p => {
        (p as HTMLElement).style.display = value ? '' : 'none';
      });
    }
  }) as EventListener);
</script>

<style>
  .publications-page {
    /* Vertical padding handled by article in global.css */
  }

  .page-header {
    margin-bottom: var(--space-8);
  }

  .page-header h1 {
    margin-top: 0;
    margin-bottom: var(--space-2);
  }

  .page-description {
    color: var(--color-text-muted);
    font-size: var(--font-size-base);
    margin: 0;
  }
</style>
