---
import BaseLayout from '../layouts/BaseLayout.astro';
import reposData from '../content/repositories.json';
import { loadRepositories } from '../lib/github';
import { config } from '../config';

const title = `Open Source | ${config.site.title}`;

// Load and fetch repo data from GitHub API
const sortedRepos = await loadRepositories(reposData.repositories);

// Language colors (GitHub style)
const langColors: Record<string, string> = {
  python: '#3572A5',
  javascript: '#f1e05a',
  typescript: '#3178c6',
  rust: '#dea584',
  go: '#00ADD8',
  java: '#b07219',
  c: '#555555',
  'c++': '#f34b7d',
  ruby: '#701516',
  shell: '#89e051',
};
---

<BaseLayout title={title} description="Open source tools and libraries">
  <article class="opensource-page">
    <div class="container">
      <div class="repos-grid" data-animate="stagger">
        {sortedRepos.map(repo => (
          <a href={repo.url} class="repo-card" target="_blank" rel="noopener noreferrer">
            <h2 class="repo-name">{repo.name}</h2>
            <p class="repo-desc">{repo.description}</p>
            <div class="repo-meta">
              {repo.language && (
                <span class="repo-lang">
                  <span class="lang-dot" style={`background: ${langColors[repo.language.toLowerCase()] || '#666'}`}></span>
                  {repo.language}
                </span>
              )}
              {repo.stars > 0 && (
                <span class="repo-stat">
                  <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.75.75 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25z"/></svg>
                  {repo.stars}
                </span>
              )}
              {repo.forks > 0 && (
                <span class="repo-stat">
                  <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"/></svg>
                  {repo.forks}
                </span>
              )}
            </div>
          </a>
        ))}
      </div>

      <p class="view-all" data-animate="fade">
        <a href={`https://github.com/${reposData.github_user}`} target="_blank" rel="noopener noreferrer">
          View all on GitHub &rarr;
        </a>
      </p>
    </div>
  </article>
</BaseLayout>

<style>
  /* 2x2 Grid like GitHub pinned repos */
  .repos-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
    margin-top: 0;
  }

  .repo-card {
    display: flex;
    flex-direction: column;
    padding: var(--space-5);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    text-decoration: none;
    background: none;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    min-height: 140px;
  }

  .repo-card:hover {
    border-color: var(--color-text-muted);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .repo-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .repo-name {
    font-family: var(--font-body);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    color: var(--color-accent);
    margin: 0 0 var(--space-2) 0;
  }

  .repo-desc {
    font-size: var(--font-size-base);
    font-family: var(--font-body);
    color: var(--color-text-secondary);
    line-height: var(--line-height-normal);
    margin: 0;
    flex: 1;
  }

  .repo-meta {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-top: var(--space-4);
    font-size: var(--font-size-sm);
    font-family: var(--font-body);
    color: var(--color-text-muted);
  }

  .repo-lang {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .lang-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .repo-stat {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .repo-stat svg {
    width: 12px;
    height: 12px;
    opacity: 0.6;
    flex-shrink: 0;
  }

  @media (max-width: 600px) {
    .repos-grid {
      grid-template-columns: 1fr;
    }

    .repo-card {
      min-height: auto;
    }
  }
</style>
