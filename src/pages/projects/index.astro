---
/**
 * Projects Index Page
 * Card-based grid layout similar to Open Source page
 */
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { config } from '../../lib/config';
import StatCard from '../../components/primitives/StatCard.astro';
import ViewDot from '../../components/primitives/ViewDot.astro';
import ViewTags from '../../components/primitives/ViewTags.astro';
import ActionLink from '../../components/primitives/ActionLink.astro';
import PreviewPanel from '../../components/PreviewPanel.astro';
import { getPageOptions } from '../../lib/preview-options';

// Page configuration
const title = 'Projects';
const description = 'Research projects, tools, and open source contributions';

// Get all projects
const projects = await getCollection('projects');

// Sort: featured first, then by date
const sortedProjects = projects.sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  const dateA = a.data.date?.valueOf() ?? 0;
  const dateB = b.data.date?.valueOf() ?? 0;
  return dateB - dateA;
});

// Separate featured and regular projects
const featuredProjects = sortedProjects.filter(p => p.data.featured);
const regularProjects = sortedProjects.filter(p => !p.data.featured);

// Get base URL
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const pageTitle = `${title} | ${config.site.title}`;

// Status labels
const statusLabels: Record<string, string> = {
  active: 'Active',
  completed: 'Completed',
  archived: 'Archived',
  paused: 'Paused',
  wip: 'In Progress',
};
---

<BaseLayout title={pageTitle} description={description}>
  <article class="projects-page">
    <div class="container">
      <header class="page-header" data-animate="fade-up">
        <h1>Projects</h1>
        <p class="page-description">{description}</p>
      </header>

      {/* Featured Projects */}
      {featuredProjects.length > 0 && (
        <section class="featured-section" data-animate="stagger">
          {featuredProjects.map(project => (
            <StatCard
              title={project.data.title}
              href={`${base}/projects/${project.slug}`}
              class="project-card featured"
            >
              <Fragment slot="subtitle">
                <div class="project-meta">
                  {project.data.status && (
                    <span class="project-status">
                      <ViewDot status={project.data.status} size="md" />
                      <span class="status-label">{statusLabels[project.data.status]}</span>
                    </span>
                  )}
                </div>
                {project.data.description && (
                  <p class="project-desc">{project.data.description}</p>
                )}
              </Fragment>
              <Fragment slot="stats">
                <div class="project-footer">
                  {project.data.tags && project.data.tags.length > 0 && (
                    <ViewTags tags={project.data.tags.slice(0, 3)} />
                  )}
                  {project.data.github && (
                    <ActionLink href={project.data.github} label="Code" icon="external" />
                  )}
                </div>
              </Fragment>
            </StatCard>
          ))}
        </section>
      )}

      {/* Regular Projects */}
      {regularProjects.length > 0 && (
        <section class="projects-section" data-animate="stagger">
          {featuredProjects.length > 0 && (
            <h3 class="section-header">All Projects</h3>
          )}
          <div class="projects-grid">
            {regularProjects.map(project => (
              <StatCard
                title={project.data.title}
                href={`${base}/projects/${project.slug}`}
                class="project-card"
              >
                <Fragment slot="subtitle">
                  <div class="project-meta">
                    {project.data.status && (
                      <span class="project-status">
                        <ViewDot status={project.data.status} size="sm" />
                        <span class="status-label">{statusLabels[project.data.status]}</span>
                      </span>
                    )}
                  </div>
                  {project.data.description && (
                    <p class="project-desc">{project.data.description}</p>
                  )}
                </Fragment>
                <Fragment slot="stats">
                  <div class="project-footer">
                    {project.data.tags && project.data.tags.length > 0 && (
                      <ViewTags tags={project.data.tags.slice(0, 3)} />
                    )}
                    {project.data.github && (
                      <ActionLink href={project.data.github} label="Code" icon="external" />
                    )}
                  </div>
                </Fragment>
              </StatCard>
            ))}
          </div>
        </section>
      )}

      {sortedProjects.length === 0 && (
        <div class="empty-state" data-animate="fade-up">
          <p>No projects to display yet. Check back soon!</p>
        </div>
      )}
    </div>
  </article>
</BaseLayout>

{import.meta.env.DEV && (
  <PreviewPanel
    pageType="projects"
    options={getPageOptions('projects')?.options || []}
  />
)}

<script>
  document.addEventListener('preview-option-change', ((e: CustomEvent) => {
    const { option, value, pageType, requiresReload } = e.detail;
    if (pageType !== 'projects') return;

    // Auto-reload handled by PreviewPanel
    if (requiresReload) return;

    // Handle columns
    if (option === 'columns') {
      const grid = document.querySelector('.projects-grid');
      if (grid) {
        grid.setAttribute('data-columns', value);
      }
    }

    // Handle showStatus
    if (option === 'showStatus') {
      document.querySelectorAll('.project-status').forEach(el => {
        (el as HTMLElement).style.display = value ? '' : 'none';
      });
    }

    // Handle showDescription
    if (option === 'showDescription') {
      document.querySelectorAll('.project-desc').forEach(el => {
        (el as HTMLElement).style.display = value ? '' : 'none';
      });
    }

    // Handle showTags
    if (option === 'showTags') {
      document.querySelectorAll('.project-footer :is(.tag-list, .tags-wrapper)').forEach(el => {
        (el as HTMLElement).style.display = value ? '' : 'none';
      });
    }
  }) as EventListener);
</script>

<style>
  .page-header {
    margin-bottom: var(--space-8);
  }

  .page-header h1 {
    margin-top: 0;
    margin-bottom: var(--space-2);
  }

  .page-description {
    color: var(--color-text-muted);
    font-size: var(--font-size-base);
    margin: 0;
  }

  /* Featured Section - full width cards */
  .featured-section {
    margin-bottom: var(--space-10);
  }

  .featured-section .project-card {
    margin-bottom: var(--space-4);
  }

  .featured-section .project-card:last-child {
    margin-bottom: 0;
  }

  .project-card.featured {
    border-left-color: var(--color-accent);
  }

  /* Section Header */
  .section-header {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 var(--space-4) 0;
  }

  /* Projects Grid - 2x2 like Open Source */
  .projects-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  /* Dynamic column support for preview mode */
  .projects-grid[data-columns='1'] {
    grid-template-columns: 1fr;
  }

  .projects-grid[data-columns='2'] {
    grid-template-columns: repeat(2, 1fr);
  }

  .projects-grid[data-columns='3'] {
    grid-template-columns: repeat(3, 1fr);
  }

  @media (max-width: 900px) {
    .projects-grid[data-columns='3'] {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 600px) {
    .projects-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Project Card Styling */
  .project-meta {
    margin-bottom: var(--space-2);
  }

  .project-status {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
  }

  .status-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    font-weight: var(--font-weight-medium);
  }

  .project-desc {
    font-size: var(--font-size-sm);
    font-family: var(--font-body);
    color: var(--color-text-muted);
    line-height: var(--line-height-normal);
    margin: 0;
  }

  .project-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    flex-wrap: wrap;
    width: 100%;
  }

  .empty-state {
    text-align: center;
    padding: var(--space-12) var(--space-4);
    color: var(--color-text-muted);
  }
</style>
