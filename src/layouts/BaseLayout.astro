---
/**
 * Base Layout
 * The main layout wrapper for all pages
 *
 * Navigation modes:
 * - floating: Safari-style floating pill nav
 * - sidebar: Left sidebar next to content
 * - inline: Simple header nav
 */

import ThemeStyles from '../components/ThemeStyles.astro';
import AnimationInit from '../components/AnimationInit.astro';
import StructuredData from '../components/StructuredData.astro';
import SettingsPanel from '../components/SettingsPanel.astro';
import { config } from '../config';
import { getNavigationWithActive, applyBasePath } from '../lib/navigation';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  image?: string;
}

const {
  title,
  description = config.site.description,
  image = "/img/og-image.jpg"
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const navMode = config.navigationMode;

// Get base path from Astro config (e.g., '/academic' for subdirectory deployments)
const base = import.meta.env.BASE_URL;

// Strip base path from current pathname for active state detection
// e.g., /academic/ becomes /, /academic/publications becomes /publications
const pathWithoutBase = base === '/'
  ? Astro.url.pathname
  : Astro.url.pathname.replace(new RegExp(`^${base}`), '') || '/';

// Get auto-generated navigation (with stripped path for active detection)
const navigation = await getNavigationWithActive(pathWithoutBase);

// Apply base path for rendering
const navItems = applyBasePath(navigation, base);

const fullName = [config.name.first, config.name.middle, config.name.last].filter(Boolean).join(' ');

const socialLinks = [
  config.social.github && { label: 'GitHub', href: `https://github.com/${config.social.github}` },
  config.social.scholar && { label: 'Scholar', href: `https://scholar.google.com/citations?user=${config.social.scholar}` },
  config.social.linkedin && { label: 'LinkedIn', href: `https://www.linkedin.com/in/${config.social.linkedin}` },
  config.social.twitter && { label: 'Twitter', href: `https://twitter.com/${config.social.twitter}` },
  config.social.orcid && { label: 'ORCID', href: `https://orcid.org/${config.social.orcid}` },
].filter(Boolean) as { label: string; href: string }[];

const footerLinks = [...config.footer.links, ...socialLinks];
---

<!DOCTYPE html>
<html lang="en" data-nav-mode={navMode}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="canonical" href={canonicalURL} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.site)} />
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.site)} />
    <link rel="icon" type="image/jpeg" href="/favicon.jpg" />
    <!-- KaTeX CSS for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <StructuredData type="WebSite" />
    <StructuredData type="Person" />
    <ThemeStyles />
    <script is:inline>
      (function() {
        const html = document.documentElement;

        // Apply light/dark theme
        const theme = localStorage.getItem('theme') ||
          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        html.setAttribute('data-theme', theme);

        // Apply stored nav mode (or use config default)
        const navMode = localStorage.getItem('nav-mode');
        if (navMode) {
          html.setAttribute('data-nav-mode', navMode);
        }

        // Apply stored typography preset (fonts, colors, styles)
        // This will override config defaults if user has customized
        try {
          // Restore fonts
          const fontsStr = localStorage.getItem('typography-fonts');
          if (fontsStr) {
            const fonts = JSON.parse(fontsStr);
            html.style.setProperty('--font-body', '"' + fonts.body + '", Georgia, serif');
            html.style.setProperty('--font-heading', '"' + fonts.heading + '", Georgia, serif');
            html.style.setProperty('--font-ui', '"' + fonts.ui + '", system-ui, sans-serif');
            html.style.setProperty('--font-mono', '"' + fonts.mono + '", monospace');
          }

          // Restore colors
          const colorsStr = localStorage.getItem('typography-colors');
          if (colorsStr) {
            const colors = JSON.parse(colorsStr);
            html.style.setProperty('--color-accent-light', colors.accentLight);
            html.style.setProperty('--color-accent-dark', colors.accentDark);
          }

          // Restore typography styles
          const stylesStr = localStorage.getItem('typography-styles');
          if (stylesStr) {
            const styles = JSON.parse(stylesStr);
            html.style.setProperty('--heading-style', styles.headingStyle);
            html.style.setProperty('--heading-weight', styles.headingWeight);
            html.style.setProperty('--body-weight', styles.bodyWeight);
          }

          // Set typography attribute
          const presetId = localStorage.getItem('typography-preset');
          if (presetId) {
            html.setAttribute('data-typography', presetId);
          }
        } catch (e) {}
      })();
    </script>
  </head>

  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="layout-wrapper">

      <!-- Floating Nav (Safari-style pill) -->
      <nav class="floating-nav" aria-label="Main navigation">
        <div class="floating-nav-pill">
          <ul class="floating-nav-links">
            {navItems.map(item => (
              <li>
                <a
                  href={item.href}
                  class:list={['floating-nav-link', { active: item.active }]}
                  target={item.external ? '_blank' : undefined}
                  rel={item.external ? 'noopener noreferrer' : undefined}
                >
                  {item.label}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </nav>

      <!-- Sidebar Nav (left of content) -->
      <aside class="sidebar-nav" aria-label="Main navigation">
        <nav class="sidebar-nav-inner">
          <ul class="sidebar-nav-links">
            {navItems.map(item => (
              <li>
                <a
                  href={item.href}
                  class:list={['sidebar-nav-link', { active: item.active }]}
                  target={item.external ? '_blank' : undefined}
                  rel={item.external ? 'noopener noreferrer' : undefined}
                >
                  {item.label}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </aside>

      <!-- Inline Nav (header style) -->
      <header class="inline-nav" aria-label="Main navigation">
        <nav class="inline-nav-inner container">
          <ul class="inline-nav-links">
            {navItems.map(item => (
              <li>
                <a
                  href={item.href}
                  class:list={['inline-nav-link', { active: item.active }]}
                  target={item.external ? '_blank' : undefined}
                  rel={item.external ? 'noopener noreferrer' : undefined}
                >
                  {item.label}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </header>

      <!-- Mobile Nav (shared across modes) -->
      <button class="mobile-nav-toggle" aria-label="Open menu" aria-expanded="false">
        <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="4" y1="8" x2="20" y2="8"></line>
          <line x1="4" y1="16" x2="20" y2="16"></line>
        </svg>
      </button>

      <div class="mobile-nav-overlay"></div>

      <div class="mobile-nav-panel">
        <button class="mobile-nav-close" aria-label="Close menu">
          <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <ul class="mobile-nav-links">
          {navItems.map(item => (
            <li>
              <a
                href={item.href}
                class:list={['mobile-nav-link', { active: item.active }]}
                target={item.external ? '_blank' : undefined}
                rel={item.external ? 'noopener noreferrer' : undefined}
              >
                {item.label}
              </a>
            </li>
          ))}
        </ul>
      </div>

      <!-- Main Content -->
      <main class="main-content" id="main-content">
        <slot />
      </main>

      <!-- Footer -->
      <footer class="site-footer">
        <div class="container footer-content">
          {config.footer.copyright && (
            <span class="footer-copy">&copy; {new Date().getFullYear()} {fullName}</span>
          )}
          <div class="footer-links">
            {footerLinks.map(link => (
              <a
                href={link.href}
                target={link.href.startsWith('mailto:') ? undefined : '_blank'}
                rel={link.href.startsWith('mailto:') ? undefined : 'noopener noreferrer'}
              >
                {link.label}
              </a>
            ))}
          </div>
        </div>
      </footer>
    </div>

    <style>
      /* ============================================
         Layout Structure
      .skip-link {
        position: absolute;
        top: -100%;
        left: 16px;
        padding: 8px 16px;
        background: var(--color-accent);
        color: white;
        border-radius: var(--radius-md);
        z-index: 9999;
        text-decoration: none;
        font-weight: 500;
      }

      .skip-link:focus {
        top: 16px;
      }
         ============================================ */
      .layout-wrapper {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .main-content {
        flex: 1;
      }

      /* ============================================
         Navigation Visibility by Mode
         ============================================ */
      .floating-nav,
      .sidebar-nav,
      .inline-nav {
        display: none;
      }

      [data-nav-mode="floating"] .floating-nav { display: block; }
      [data-nav-mode="sidebar"] .sidebar-nav { display: block; }
      [data-nav-mode="inline"] .inline-nav { display: block; }

      /* Legacy mode support */
      [data-nav-mode="floating-icon"] .floating-nav { display: block; }
      [data-nav-mode="minimal"] .sidebar-nav { display: block; }

      /* ============================================
         FLOATING NAV - Minimal bottom pill
         Subtle, editorial design that integrates with content
         ============================================ */
      .floating-nav {
        position: fixed;
        bottom: calc(var(--space-8) + env(safe-area-inset-bottom, 0px));
        left: 50%;
        transform: translateX(-50%) translateY(0);
        z-index: var(--z-sticky);
        transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                    opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .floating-nav.hidden {
        transform: translateX(-50%) translateY(calc(100% + var(--space-12)));
        opacity: 0;
        pointer-events: none;
      }

      .floating-nav-pill {
        display: flex;
        align-items: center;
        gap: 0;
        padding: 6px;
        background: var(--color-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-full);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      }

      [data-theme="dark"] .floating-nav-pill {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
      }

      .floating-nav-links {
        display: flex;
        align-items: center;
        gap: 0;
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .floating-nav-links li {
        display: flex;
        align-items: center;
        margin: 0;
        padding: 0;
      }

      .floating-nav-link {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 32px;
        padding: 0 16px;
        font-family: var(--font-body);
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-medium);
        line-height: 1;
        color: var(--color-text-muted);
        text-decoration: none;
        background: none;
        border-radius: var(--radius-full);
        transition: color 0.2s ease, background 0.2s ease;
      }

      .floating-nav-link:hover {
        color: var(--color-text);
      }

      .floating-nav-link.active {
        color: var(--color-text);
      }

      /* No content offset needed - nav is at bottom */
      [data-nav-mode="floating"] .main-content,
      [data-nav-mode="floating-icon"] .main-content {
        padding-top: 0;
        padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));
      }

      /* ============================================
         SIDEBAR NAV - Alongside content (centered)
         ============================================ */
      [data-nav-mode="sidebar"] .layout-wrapper,
      [data-nav-mode="minimal"] .layout-wrapper {
        max-width: calc(var(--content-max-width) + 180px);
        margin: 0 auto;
        display: grid;
        grid-template-columns: 140px 1fr;
        grid-template-rows: 1fr auto;
        grid-template-areas:
          "sidebar main"
          "footer footer";
        gap: var(--space-8);
        padding: 0 var(--space-4);
      }

      .sidebar-nav {
        grid-area: sidebar;
        position: sticky;
        top: 0;
        height: fit-content;
        /* Match article padding exactly */
        padding-top: var(--content-top-padding);
      }

      .sidebar-nav-inner {
        display: flex;
        flex-direction: column;
      }

      .sidebar-nav-links {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      /* First link - remove top padding and left padding for exact alignment */
      .sidebar-nav-links li:first-child .sidebar-nav-link {
        padding-top: 0;
        padding-left: 0;
      }

      .sidebar-nav-link {
        display: block;
        padding: var(--space-2) 0;
        font-family: var(--font-body);
        font-size: var(--font-size-base);
        line-height: var(--line-height-normal);
        color: var(--color-text-muted);
        text-decoration: none;
        background: none;
        transition: all 0.15s ease;
      }

      .sidebar-nav-link:hover {
        color: var(--color-text);
      }

      .sidebar-nav-link.active {
        color: var(--color-text);
        font-weight: var(--font-weight-medium);
      }

      [data-nav-mode="sidebar"] .main-content,
      [data-nav-mode="minimal"] .main-content {
        grid-area: main;
        min-width: 0;
      }

      [data-nav-mode="sidebar"] .site-footer,
      [data-nav-mode="minimal"] .site-footer {
        grid-area: footer;
      }

      /* ============================================
         INLINE NAV - Header style
         ============================================ */
      .inline-nav {
        padding: var(--space-6) 0;
        border-bottom: 1px solid var(--color-border);
        margin-bottom: var(--space-6);
      }

      .inline-nav-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .inline-nav-links {
        display: flex;
        align-items: center;
        gap: var(--space-6);
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .inline-nav-link {
        font-family: var(--font-body);
        font-size: var(--font-size-base);
        color: var(--color-text-secondary);
        text-decoration: none;
        background: none;
        transition: color 0.15s ease;
      }

      .inline-nav-link:hover {
        color: var(--color-text);
      }

      .inline-nav-link.active {
        color: var(--color-accent);
      }

      /* ============================================
         MOBILE NAV
         ============================================ */
      .mobile-nav-toggle {
        display: none;
        position: fixed;
        top: var(--space-4);
        right: var(--space-4);
        z-index: var(--z-sticky);
        width: 44px;
        height: 44px;
        align-items: center;
        justify-content: center;
        background: var(--color-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .mobile-nav-toggle svg {
        color: var(--color-text);
      }

      .mobile-nav-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: var(--z-modal);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .mobile-nav-overlay.visible {
        opacity: 1;
        visibility: visible;
      }

      .mobile-nav-panel {
        display: none;
        position: fixed;
        top: 0;
        right: 0;
        width: min(280px, 85vw);
        height: 100vh;
        background: var(--color-bg);
        z-index: calc(var(--z-modal) + 1);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        padding: var(--space-6);
        flex-direction: column;
      }

      .mobile-nav-panel.open {
        transform: translateX(0);
      }

      .mobile-nav-close {
        position: absolute;
        top: var(--space-4);
        right: var(--space-4);
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--color-text-secondary);
      }

      .mobile-nav-links {
        list-style: none;
        margin: var(--space-12) 0 0 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
      }

      .mobile-nav-link {
        display: block;
        padding: var(--space-3) var(--space-4);
        font-family: var(--font-body);
        font-size: var(--font-size-base);
        color: var(--color-text-secondary);
        text-decoration: none;
        border-radius: var(--radius-md);
        transition: all 0.15s ease;
      }

      .mobile-nav-link:hover,
      .mobile-nav-link.active {
        color: var(--color-text);
        background: var(--color-bg-alt);
      }

      .mobile-nav-link.active {
        color: var(--color-accent);
      }

      /* Mobile breakpoint */
      @media (max-width: 768px) {
        .mobile-nav-toggle,
        .mobile-nav-overlay,
        .mobile-nav-panel {
          display: flex;
        }

        .floating-nav,
        .sidebar-nav,
        .inline-nav {
          display: none !important;
        }

        [data-nav-mode="sidebar"] .layout-wrapper,
        [data-nav-mode="minimal"] .layout-wrapper {
          display: flex;
          flex-direction: column;
        }

        .main-content {
          padding-top: calc(60px + var(--space-4)) !important;
        }
      }

      /* ============================================
         FOOTER
         ============================================ */
      .site-footer {
        margin-top: var(--space-16);
        padding: var(--space-6) 0;
        border-top: 1px solid var(--color-border);
      }

      .footer-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-4);
      }

      .footer-copy {
        font-size: var(--font-size-xs);
        color: var(--color-text-muted);
      }

      .footer-links {
        display: flex;
        gap: var(--space-4);
      }

      .footer-links a {
        font-size: var(--font-size-xs);
        color: var(--color-text-muted);
        text-decoration: none;
        background: none;
        transition: color 0.15s ease;
      }

      .footer-links a:hover {
        color: var(--color-text);
      }

      @media (max-width: 500px) {
        .footer-content {
          flex-direction: column;
          gap: var(--space-2);
        }
      }
    </style>

    <script>
      // Mobile nav toggle
      const toggle = document.querySelector('.mobile-nav-toggle');
      const overlay = document.querySelector('.mobile-nav-overlay');
      const panel = document.querySelector('.mobile-nav-panel');
      const close = document.querySelector('.mobile-nav-close');

      function openMobileNav() {
        panel?.classList.add('open');
        overlay?.classList.add('visible');
        toggle?.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
      }

      function closeMobileNav() {
        panel?.classList.remove('open');
        overlay?.classList.remove('visible');
        toggle?.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }

      toggle?.addEventListener('click', openMobileNav);
      close?.addEventListener('click', closeMobileNav);
      overlay?.addEventListener('click', closeMobileNav);

      // Close on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeMobileNav();
      });

      // Floating nav auto-hide on scroll
      const floatingNav = document.querySelector('.floating-nav');
      let lastScrollY = window.scrollY;
      let ticking = false;
      const scrollThreshold = 50; // Minimum scroll before hiding

      function updateFloatingNav() {
        const currentScrollY = window.scrollY;
        const scrollDelta = currentScrollY - lastScrollY;

        if (floatingNav) {
          // Hide when scrolling down past threshold, show when scrolling up
          if (scrollDelta > 10 && currentScrollY > scrollThreshold) {
            floatingNav.classList.add('hidden');
          } else if (scrollDelta < -10 || currentScrollY < scrollThreshold) {
            floatingNav.classList.remove('hidden');
          }
        }

        lastScrollY = currentScrollY;
        ticking = false;
      }

      window.addEventListener('scroll', () => {
        if (!ticking) {
          requestAnimationFrame(updateFloatingNav);
          ticking = true;
        }
      }, { passive: true });

      // Show nav when hovering near bottom of screen
      document.addEventListener('mousemove', (e) => {
        if (floatingNav && window.innerHeight - e.clientY < 100) {
          floatingNav.classList.remove('hidden');
        }
      });
    </script>

    <AnimationInit />

    {/* Settings panel - allows users to customize theme */}
    <SettingsPanel />
  </body>
</html>
