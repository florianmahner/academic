---
/**
 * PreviewPanel - Page-specific options panel for dev mode
 *
 * Shows a toggle button that reveals contextual configuration options
 * for the current page. Options vary by page type.
 *
 * @prop pageType - The type of page (publications, news, blog, etc.)
 * @prop options - Page-specific options schema
 */

interface Option {
  id: string;
  label: string;
  type: 'toggle' | 'select' | 'radio';
  value: any;
  choices?: { id: string; label: string }[];
  requiresReload?: boolean;
}

interface Props {
  pageType: string;
  options: Option[];
}

const { pageType, options } = Astro.props;
---

<div id="preview-panel" class="preview-panel" data-page-type={pageType}>
  <button id="preview-toggle" class="preview-toggle" aria-label="Toggle preview options">
    <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/>
      <path d="m9 12 2 2 4-4"/>
    </svg>
    <span class="toggle-label">Preview</span>
    <span class="dev-badge">DEV</span>
  </button>

  <aside id="preview-sidebar" class="preview-sidebar" hidden>
    <header class="sidebar-header">
      <h2>Page Options</h2>
      <button id="preview-close" class="close-btn" aria-label="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </header>

    <div class="sidebar-body">
      {options.map(option => (
        <div class="option-group" data-option-id={option.id}>
          <label class="option-label">{option.label}</label>

          {option.type === 'toggle' && (
            <button
              class="toggle-switch"
              data-option={option.id}
              data-value={String(option.value)}
              data-requires-reload={String(option.requiresReload || false)}
              aria-pressed={String(option.value)}
            >
              <span class="switch-track">
                <span class="switch-thumb"></span>
              </span>
            </button>
          )}

          {option.type === 'select' && option.choices && (
            <select class="option-select" data-option={option.id} data-requires-reload={String(option.requiresReload || false)}>
              {option.choices.map(choice => (
                <option value={choice.id} selected={choice.id === option.value}>
                  {choice.label}
                </option>
              ))}
            </select>
          )}

          {option.type === 'radio' && option.choices && (
            <div class="radio-group" data-requires-reload={String(option.requiresReload || false)}>
              {option.choices.map(choice => (
                <button
                  class:list={['radio-option', { active: choice.id === option.value }]}
                  data-option={option.id}
                  data-value={choice.id}
                >
                  {choice.label}
                </button>
              ))}
            </div>
          )}
        </div>
      ))}
    </div>

    <footer class="sidebar-footer">
      <button id="copy-config" class="copy-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        Copy Config
      </button>
    </footer>
  </aside>
</div>

<style>
  .preview-panel {
    position: fixed;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    z-index: 9990;
    font-family: system-ui, -apple-system, sans-serif;
    font-size: 14px;
  }

  /* Toggle button */
  .preview-toggle {
    position: relative;
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: 10px 14px;
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: 8px 0 0 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
    box-shadow: -2px 2px 8px rgba(0, 0, 0, 0.15);
  }

  .preview-toggle:hover {
    padding-right: 18px;
  }

  .toggle-label {
    display: none;
  }

  .preview-toggle:hover .toggle-label {
    display: inline;
  }

  /* DEV badge */
  .dev-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #f59e0b;
    color: white;
    font-size: 9px;
    font-weight: 700;
    padding: 2px 5px;
    border-radius: 4px;
    letter-spacing: 0.05em;
  }

  /* Sidebar */
  .preview-sidebar {
    position: fixed;
    top: 0;
    right: 0;
    width: 320px;
    height: 100vh;
    background: var(--color-bg);
    border-left: 1px solid var(--color-border);
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    animation: slideIn 0.2s ease;
  }

  .preview-sidebar[hidden] {
    display: none;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
    }
    to {
      transform: translateX(0);
    }
  }

  .sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--color-border);
  }

  .sidebar-header h2 {
    font-size: 15px;
    font-weight: 600;
    margin: 0;
    color: var(--color-text);
  }

  .close-btn {
    width: 32px;
    height: 32px;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--color-text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.15s;
  }

  .close-btn:hover {
    background: var(--color-bg-secondary);
    color: var(--color-text);
  }

  .sidebar-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  /* Option groups */
  .option-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .option-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Toggle switch */
  .toggle-switch {
    width: 48px;
    height: 28px;
    background: var(--color-border);
    border: none;
    border-radius: 14px;
    cursor: pointer;
    padding: 2px;
    transition: background 0.2s;
  }

  .toggle-switch[data-value="true"] {
    background: var(--color-accent);
  }

  .switch-track {
    display: block;
    width: 100%;
    height: 100%;
    position: relative;
  }

  .switch-thumb {
    position: absolute;
    top: 0;
    left: 0;
    width: 24px;
    height: 24px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    transition: transform 0.2s;
  }

  .toggle-switch[data-value="true"] .switch-thumb {
    transform: translateX(20px);
  }

  /* Select */
  .option-select {
    padding: 10px 12px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-text);
    font-size: 14px;
    cursor: pointer;
  }

  .option-select:focus {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* Radio group */
  .radio-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .radio-option {
    padding: 8px 14px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    color: var(--color-text-secondary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }

  .radio-option:hover {
    border-color: var(--color-accent);
  }

  .radio-option.active {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  /* Footer */
  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--color-border);
  }

  .copy-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-text);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }

  .copy-btn:hover {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  /* Hide in production */
  @media print {
    .preview-panel {
      display: none;
    }
  }
</style>

<script>
  function initPreviewPanel() {
    const panel = document.getElementById('preview-panel');
    const toggle = document.getElementById('preview-toggle');
    const sidebar = document.getElementById('preview-sidebar');
    const close = document.getElementById('preview-close');
    const copyBtn = document.getElementById('copy-config');
    const pageType = panel?.getAttribute('data-page-type');

    if (!panel || !toggle || !sidebar) return;

    // State
    let currentOptions: Record<string, any> = {};

    // Load state from URL params first (for view/style), then localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const urlView = urlParams.get('view');
    const urlStyle = urlParams.get('style');

    const savedState = localStorage.getItem(`preview-${pageType}`);
    if (savedState) {
      try {
        currentOptions = JSON.parse(savedState);
      } catch (e) {
        console.error('Failed to load preview state:', e);
      }
    }

    // URL params override localStorage for view/style
    if (urlView) currentOptions['view'] = urlView;
    if (urlStyle) currentOptions['style'] = urlStyle;

    // Apply all options to UI
    applyAllOptions();

    // Open/close
    toggle.addEventListener('click', () => {
      sidebar.hidden = !sidebar.hidden;
    });

    close?.addEventListener('click', () => {
      sidebar.hidden = true;
    });

    // Handle toggle switches
    sidebar.querySelectorAll('.toggle-switch').forEach(btn => {
      btn.addEventListener('click', () => {
        const option = btn.getAttribute('data-option');
        const requiresReload = btn.getAttribute('data-requires-reload') === 'true';
        const currentValue = btn.getAttribute('data-value') === 'true';
        const newValue = !currentValue;

        btn.setAttribute('data-value', String(newValue));
        btn.setAttribute('aria-pressed', String(newValue));

        if (option) {
          currentOptions[option] = newValue;
          applyOption(option, newValue, requiresReload);
          saveState();
        }
      });
    });

    // Handle selects
    sidebar.querySelectorAll('.option-select').forEach(select => {
      select.addEventListener('change', (e) => {
        const target = e.target as HTMLSelectElement;
        const option = target.getAttribute('data-option');
        const requiresReload = target.getAttribute('data-requires-reload') === 'true';
        const value = target.value;

        if (option) {
          currentOptions[option] = value;
          applyOption(option, value, requiresReload);
          saveState();
        }
      });
    });

    // Handle radio buttons
    sidebar.querySelectorAll('.radio-option').forEach(btn => {
      btn.addEventListener('click', () => {
        const option = btn.getAttribute('data-option');
        const value = btn.getAttribute('data-value');
        const group = btn.closest('.radio-group');

        // Update UI
        group?.querySelectorAll('.radio-option').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        if (option && value) {
          currentOptions[option] = value;
          applyOption(option, value);
          saveState();
        }
      });
    });

    // Copy config
    copyBtn?.addEventListener('click', () => {
      const yaml = generateYaml();
      navigator.clipboard.writeText(yaml).then(() => {
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Copied!';
        setTimeout(() => {
          copyBtn.innerHTML = originalText;
        }, 2000);
      });
    });

    // Apply option to page
    function applyOption(option: string, value: any) {
      // Dispatch custom event for page-specific handling
      const event = new CustomEvent('preview-option-change', {
        detail: { option, value, pageType }
      });
      document.dispatchEvent(event);

      // Also set data attribute on body for CSS-based changes
      document.body.setAttribute(`data-preview-${option}`, String(value));

      // For view/style changes, reload with URL param so Astro renders the correct view
      if (option === 'view' || option === 'style') {
        window.location.href = window.location.pathname + '?' + option + '=' + value;
        return;
      }
    }

    function applyAllOptions() {
      Object.entries(currentOptions).forEach(([option, value]) => {
        // Don't reload when restoring - only set data attributes
        document.body.setAttribute(`data-preview-${option}`, String(value));

        // Update UI state
        const toggle = sidebar.querySelector(`[data-option="${option}"].toggle-switch`);
        if (toggle) {
          toggle.setAttribute('data-value', String(value));
          toggle.setAttribute('aria-pressed', String(value));
        }

        const select = sidebar.querySelector(`[data-option="${option}"].option-select`) as HTMLSelectElement;
        if (select) {
          select.value = String(value);
        }

        const radio = sidebar.querySelector(`[data-option="${option}"][data-value="${value}"].radio-option`);
        if (radio) {
          radio.closest('.radio-group')?.querySelectorAll('.radio-option').forEach(b => b.classList.remove('active'));
          radio.classList.add('active');
        }
      });
    }

    function saveState() {
      localStorage.setItem(`preview-${pageType}`, JSON.stringify(currentOptions));
    }

    function generateYaml() {
      const lines: string[] = [];
      lines.push(`# Add to config.yaml under ${pageType} section:`);
      lines.push('');
      lines.push(`${pageType}:`);

      Object.entries(currentOptions).forEach(([key, value]) => {
        if (typeof value === 'boolean') {
          lines.push(`  ${key}: ${value}`);
        } else if (typeof value === 'number') {
          lines.push(`  ${key}: ${value}`);
        } else {
          // String values - don't quote simple strings
          lines.push(`  ${key}: ${value}`);
        }
      });

      return lines.join('\n');
    }

    // Escape to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !sidebar.hidden) {
        sidebar.hidden = true;
      }
    });
  }

  initPreviewPanel();
  document.addEventListener('astro:after-swap', initPreviewPanel);
</script>
