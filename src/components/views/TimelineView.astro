---
/**
 * TimelineView Component
 *
 * Chronological list view with year groupings and type indicators.
 * Best for: News feeds, talks, mixed content streams.
 *
 * Styles:
 * - "minimal": Clean rows with date column and small dots
 * - "strip": Simple vertical line with connected dots
 * - "classic": Elegant timeline with gradient accent line, ringed dots, year pills
 * - "alternating": True timeline with items alternating left/right of center line
 *
 * Frontmatter Configuration:
 * ```yaml
 * view: "timeline"
 * viewConfig:
 *   style: "classic"          # "minimal" | "strip" | "classic"
 *   groupBy: "year"           # Group items by year
 *   showDot: true             # Show type/status indicator
 *   dotType: "content"        # "content" | "status"
 *   showDate: true            # Show date
 *   dateFormat: "short"       # "short" | "long" | "month-year"
 *   showDescription: false    # Show description text
 *   showContext: true         # Show context line (event/venue)
 *   showLinks: ["slides", "video", "pdf"]
 *   linkStyle: "text"         # "icons" | "text" | "both"
 * ```
 */

import ViewDate from '../primitives/ViewDate.astro';
import ViewDot from '../primitives/ViewDot.astro';
import ViewTags from '../primitives/ViewTags.astro';
import ActionLink from '../primitives/ActionLink.astro';

interface ViewItem {
  title: string;
  slug?: string;
  date: Date;
  description?: string;
  tags?: string[];
  type?: 'blog' | 'talk' | 'publication' | 'project' | 'teaching';
  status?: 'active' | 'completed' | 'archived' | 'paused';
  event?: string;
  location?: string;
  venue?: string;
  institution?: string;
  authors?: string[];
  url?: string;
  github?: string;
  slides?: string;
  video?: string;
  pdf?: string;
  code?: string;
  poster?: string;
  materials?: string;
}

interface ViewConfig {
  style?: 'minimal' | 'strip' | 'classic' | 'alternating';
  groupBy?: 'year' | 'none';
  showDot?: boolean;
  dotType?: 'content' | 'status';
  showDate?: boolean;
  dateFormat?: 'short' | 'long' | 'month-year' | 'year';
  showDescription?: boolean;
  descriptionLimit?: number;
  showContext?: boolean;
  showAuthors?: boolean;
  authorLimit?: number;
  showTags?: boolean;
  tagLimit?: number;
  showLinks?: string[];
}

interface Props {
  items: ViewItem[];
  config?: ViewConfig;
  collection?: string;
  class?: string;
}

const { items, config = {}, collection, class: className } = Astro.props;

// Get base URL for proper path prefixing
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const {
  style = 'minimal',
  groupBy = 'year',
  showDot = true,
  dotType = 'content',
  showDate = true,
  dateFormat = 'short',
  showDescription = false,
  descriptionLimit = 150,
  showContext = true,
  showAuthors = false,
  authorLimit = 3,
  showTags = false,
  tagLimit = 3,
  showLinks = [],
} = config;

function groupByYear(items: ViewItem[]): Record<string, ViewItem[]> {
  return items.reduce((acc, item) => {
    const year = item.date.getFullYear().toString();
    if (!acc[year]) acc[year] = [];
    acc[year].push(item);
    return acc;
  }, {} as Record<string, ViewItem[]>);
}

const grouped = groupBy === 'year' ? groupByYear(items) : { all: items };
const years = Object.keys(grouped).sort((a, b) => parseInt(b) - parseInt(a));

function getItemLink(item: ViewItem): string | null {
  if (!item.slug) return null;
  if (item.type === 'blog') return `${base}/blog/${item.slug}`;
  if (item.type === 'talk') return `${base}/talks/${item.slug}`;
  if (item.type === 'project') return `${base}/projects/${item.slug}`;
  if (item.type === 'teaching') return `${base}/teaching/${item.slug}`;
  if (collection) return `${base}/${collection}/${item.slug}`;
  return null;
}

function getActionLinks(item: ViewItem): Array<{ label: string; url: string }> {
  const links: Array<{ label: string; url: string }> = [];
  const allowedLinks = showLinks.length > 0 ? showLinks : ['slides', 'video', 'pdf', 'code', 'github', 'materials'];

  if (allowedLinks.includes('pdf') && item.pdf) links.push({ label: 'PDF', url: item.pdf });
  if (allowedLinks.includes('slides') && item.slides) links.push({ label: 'Slides', url: item.slides });
  if (allowedLinks.includes('video') && item.video) links.push({ label: 'Video', url: item.video });
  if (allowedLinks.includes('code') && item.code) links.push({ label: 'Code', url: item.code });
  if (allowedLinks.includes('github') && item.github) links.push({ label: 'GitHub', url: item.github });
  if (allowedLinks.includes('poster') && item.poster) links.push({ label: 'Poster', url: item.poster });
  if (allowedLinks.includes('materials') && item.materials) links.push({ label: 'Materials', url: item.materials });

  return links;
}

function truncate(text: string, limit: number): string {
  if (text.length <= limit) return text;
  return text.slice(0, limit).trim() + '...';
}

const isClassic = style === 'classic';
const isStrip = style === 'strip';
const isMinimal = style === 'minimal';
const isAlternating = style === 'alternating';

// Track global index for alternating layout
let globalIndex = 0;
---

<div class:list={['timeline-view', `timeline-view--${style}`, className]}>
  {years.map(year => (
    <section class="timeline-group" data-animate="fade-up">
      {/* Year header - different styles */}
      {groupBy === 'year' && year !== 'all' && (
        <>
          {(isClassic || isAlternating) ? (
            <div class="year-marker">
              <span class="year-pill">{year}</span>
            </div>
          ) : (
            <h2 class="year-header">{year}</h2>
          )}
        </>
      )}

      <ul class="timeline-list">
        {grouped[year].map((item, index) => {
          const link = getItemLink(item);
          const actionLinks = getActionLinks(item);
          const isLast = index === grouped[year].length - 1;
          const isActive = item.status === 'active';
          const position = isAlternating ? (globalIndex % 2 === 0 ? 'left' : 'right') : null;
          globalIndex++;

          return (
            <li
              class:list={['timeline-item', 'view-item', { 'is-last': isLast }]}
              data-type={item.type}
              data-position={position}
            >
              {/* Classic/Strip/Alternating: Dot marker */}
              {(isClassic || isStrip || isAlternating) && (
                <div class="dot-wrapper">
                  <div
                    class:list={['timeline-dot', { 'dot-pulse': isActive }]}
                    data-type={dotType === 'content' ? item.type : undefined}
                    data-status={dotType === 'status' ? item.status : undefined}
                  ></div>
                </div>
              )}

              {/* Minimal: Date column */}
              {isMinimal && showDate && (
                <div class="date-col">
                  <ViewDate date={item.date} format={dateFormat} />
                </div>
              )}

              {/* Minimal: Dot indicator */}
              {isMinimal && showDot && (
                <div class="dot-col">
                  <span class="dot-baseline">&#8203;<ViewDot
                    type={dotType === 'content' ? item.type : undefined}
                    status={dotType === 'status' ? item.status : undefined}
                  /></span>
                </div>
              )}

              {/* Content */}
              <div class="item-content">
                {/* Date for classic/strip/alternating */}
                {(isClassic || isStrip || isAlternating) && showDate && (
                  <time class="item-date">
                    <ViewDate date={item.date} format={dateFormat} />
                  </time>
                )}

                <div class="item-header">
                  {link ? (
                    <a href={link} class="item-title">{item.title}</a>
                  ) : (
                    <span class="item-title">{item.title}</span>
                  )}
                  {/* Inline links for compact timeline display */}
                  {actionLinks.length > 0 && (
                    <span class="item-links-inline">
                      {actionLinks.map((actionLink) => (
                        <ActionLink
                          href={actionLink.url}
                          label={actionLink.label}
                          icon={actionLink.label.toLowerCase().includes('code') ? 'code' : 'external'}
                        />
                      ))}
                    </span>
                  )}
                </div>

                {showContext && (item.event || item.venue || item.institution) && (
                  <div class="item-context">
                    {item.event && <span class="context-primary">{item.event}</span>}
                    {item.location && <span class="context-secondary"> Â· {item.location}</span>}
                    {item.venue && <span class="context-primary">{item.venue}</span>}
                    {item.institution && <span class="context-primary">{item.institution}</span>}
                  </div>
                )}

                {showAuthors && item.authors && item.authors.length > 0 && (
                  <div class="item-authors">
                    {item.authors.slice(0, authorLimit).join(', ')}
                    {item.authors.length > authorLimit && ' et al.'}
                  </div>
                )}

                {showDescription && item.description && (
                  <p class="item-description">
                    {truncate(item.description, descriptionLimit)}
                  </p>
                )}

                {showTags && item.tags && item.tags.length > 0 && (
                  <ViewTags tags={item.tags} limit={tagLimit} style="minimal" class="item-tags" />
                )}
              </div>
            </li>
          );
        })}
      </ul>
    </section>
  ))}
</div>

<style>
  .timeline-view {
    max-width: 100%;
  }

  .timeline-group {
    margin-bottom: var(--space-10);
  }

  .timeline-group:last-child {
    margin-bottom: 0;
  }

  .timeline-list {
    list-style: none;
    margin: 0;
    padding: 0;
    position: relative;
  }

  /* ======================
     YEAR HEADERS
     ====================== */

  /* Minimal/Strip: Simple header */
  .year-header {
    font-family: var(--view-year-font);
    font-size: var(--view-year-size);
    font-weight: var(--view-year-weight);
    color: var(--view-year-color);
    margin: 0 0 var(--space-4) 0;
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--color-border);
  }

  /* Classic: Year pill */
  .year-marker {
    margin-bottom: var(--space-6);
  }

  .year-pill {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-family: var(--view-year-font);
    font-size: var(--view-year-size);
    font-weight: var(--view-year-weight);
    color: var(--color-text);
  }

  /* ======================
     MINIMAL STYLE
     ====================== */
  .timeline-view--minimal .timeline-item {
    display: grid;
    grid-template-columns: 60px 16px 1fr;
    gap: var(--view-gap);
    align-items: baseline;
    padding: var(--view-item-padding) 0;
    border-bottom: 1px solid var(--color-border);
    transition: background-color var(--view-transition);
  }

  .timeline-view--minimal .timeline-item:last-child {
    border-bottom: none;
  }

  @media (hover: hover) {
    .timeline-view--minimal .timeline-item:hover .item-title {
      color: var(--color-accent);
    }
  }

  .date-col {
    text-align: right;
  }

  .dot-col {
    text-align: center;
  }

  .dot-baseline {
    font-size: var(--view-title-size);
    line-height: var(--line-height-snug);
  }

  .dot-baseline :global(.view-dot) {
    vertical-align: middle;
  }

  /* ======================
     STRIP STYLE
     ====================== */
  .timeline-view--strip .timeline-item {
    display: flex;
    gap: var(--space-4);
    padding-bottom: var(--space-6);
    position: relative;
  }

  .timeline-view--strip .timeline-item:not(.is-last)::before {
    content: '';
    position: absolute;
    left: 5px;
    top: 16px;
    bottom: 0;
    width: 2px;
    background-color: var(--color-border);
  }

  .timeline-view--strip .dot-wrapper {
    flex-shrink: 0;
    width: 12px;
    padding-top: 4px;
  }

  .timeline-view--strip .timeline-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--color-accent);
    position: relative;
    z-index: 1;
  }

  /* ======================
     CLASSIC STYLE
     ====================== */
  .timeline-view--classic .timeline-list::before {
    content: '';
    position: absolute;
    left: 7px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(
      to bottom,
      transparent 0%,
      var(--color-accent) 5%,
      var(--color-accent) 95%,
      transparent 100%
    );
  }

  .timeline-view--classic .timeline-item {
    display: flex;
    gap: var(--space-5);
    padding-bottom: var(--space-8);
    position: relative;
  }

  .timeline-view--classic .timeline-item:last-child {
    padding-bottom: 0;
  }

  .timeline-view--classic .dot-wrapper {
    flex-shrink: 0;
    width: 16px;
    padding-top: 2px;
    z-index: 2;
  }

  .timeline-view--classic .timeline-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--color-accent);
    border: 3px solid var(--color-bg);
    box-shadow: 0 0 0 2px var(--color-accent);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .timeline-view--classic .timeline-item:hover .timeline-dot {
    transform: scale(1.2);
    box-shadow: 0 0 0 3px var(--color-accent);
  }

  /* Pulsing dot for active items */
  .timeline-view--classic .dot-pulse {
    animation: pulse-dot 2s ease-in-out infinite;
  }

  .timeline-view--classic .dot-pulse::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--color-accent);
    opacity: 0.4;
    animation: ping-dot 2s ease-out infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }

  @keyframes ping-dot {
    75%, 100% {
      transform: translate(-50%, -50%) scale(2.5);
      opacity: 0;
    }
  }

  .timeline-view--classic .item-content {
    flex: 1;
    min-width: 0;
    padding-top: 0;
  }

  /* ======================
     ALTERNATING STYLE
     ====================== */
  .timeline-view--alternating .timeline-list {
    position: relative;
  }

  .timeline-view--alternating .timeline-list::before {
    content: '';
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 2px;
    transform: translateX(-50%);
    background: linear-gradient(
      to bottom,
      transparent 0%,
      var(--color-accent) 5%,
      var(--color-accent) 95%,
      transparent 100%
    );
  }

  .timeline-view--alternating .timeline-item {
    display: flex;
    align-items: flex-start;
    padding-bottom: var(--space-8);
    position: relative;
  }

  .timeline-view--alternating .timeline-item:last-child {
    padding-bottom: 0;
  }

  /* Left side items: content on left, dot in center */
  .timeline-view--alternating .timeline-item[data-position="left"] {
    flex-direction: row;
    padding-right: calc(50% + var(--space-8));
  }

  .timeline-view--alternating .timeline-item[data-position="left"] .item-content {
    text-align: right;
    order: 0;
  }

  .timeline-view--alternating .timeline-item[data-position="left"] .dot-wrapper {
    order: 1;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
  }

  /* Right side items: dot in center, content on right */
  .timeline-view--alternating .timeline-item[data-position="right"] {
    flex-direction: row;
    padding-left: calc(50% + var(--space-8));
  }

  .timeline-view--alternating .timeline-item[data-position="right"] .dot-wrapper {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
  }

  .timeline-view--alternating .dot-wrapper {
    flex-shrink: 0;
    width: 16px;
    padding-top: 2px;
    z-index: 2;
  }

  .timeline-view--alternating .timeline-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--color-accent);
    border: 3px solid var(--color-bg);
    box-shadow: 0 0 0 2px var(--color-accent);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .timeline-view--alternating .timeline-item:hover .timeline-dot {
    transform: scale(1.2);
    box-shadow: 0 0 0 3px var(--color-accent);
  }

  /* Pulsing dot for active items */
  .timeline-view--alternating .dot-pulse {
    animation: pulse-dot 2s ease-in-out infinite;
  }

  .timeline-view--alternating .item-content {
    flex: 1;
    min-width: 0;
  }

  /* Align text properly for left items */
  .timeline-view--alternating .timeline-item[data-position="left"] .item-header {
    text-align: right;
  }

  .timeline-view--alternating .timeline-item[data-position="left"] .item-context {
    text-align: right;
  }

  .timeline-view--alternating .timeline-item[data-position="left"] .item-links {
    justify-content: flex-end;
  }

  /* Year marker for alternating */
  .timeline-view--alternating .year-marker {
    text-align: center;
    margin-bottom: var(--space-8);
    position: relative;
  }

  .timeline-view--alternating .year-pill {
    display: inline-block;
    padding: var(--space-2) var(--space-5);
    background: var(--color-bg);
    border: 2px solid var(--color-accent);
    border-radius: var(--radius-full);
    font-family: var(--view-year-font);
    font-size: var(--view-year-size);
    font-weight: var(--font-weight-bold);
    color: var(--color-accent);
    position: relative;
    z-index: 3;
  }

  /* ======================
     DOT COLORS (Classic/Strip/Alternating)
     ====================== */
  .timeline-dot[data-type="blog"] { background-color: var(--view-dot-blog); box-shadow: 0 0 0 2px var(--view-dot-blog); }
  .timeline-dot[data-type="talk"] { background-color: var(--view-dot-talk); box-shadow: 0 0 0 2px var(--view-dot-talk); }
  .timeline-dot[data-type="publication"] { background-color: var(--view-dot-publication); box-shadow: 0 0 0 2px var(--view-dot-publication); }
  .timeline-dot[data-type="project"] { background-color: var(--view-dot-project); box-shadow: 0 0 0 2px var(--view-dot-project); }
  .timeline-dot[data-type="teaching"] { background-color: var(--view-dot-teaching); box-shadow: 0 0 0 2px var(--view-dot-teaching); }
  .timeline-dot[data-status="active"] { background-color: var(--view-dot-active); box-shadow: 0 0 0 2px var(--view-dot-active); }
  .timeline-dot[data-status="completed"] { background-color: var(--view-dot-completed); box-shadow: 0 0 0 2px var(--view-dot-completed); }

  /* Strip style: smaller, no ring */
  .timeline-view--strip .timeline-dot {
    box-shadow: none;
  }
  .timeline-view--strip .timeline-dot[data-type],
  .timeline-view--strip .timeline-dot[data-status] {
    box-shadow: none;
  }

  /* ======================
     SHARED CONTENT STYLES
     ====================== */
  .item-content {
    min-width: 0;
    flex: 1;
  }

  .item-date {
    display: block;
    font-size: var(--view-date-size);
    font-family: var(--view-date-font);
    color: var(--view-date-color);
    margin-bottom: var(--space-1);
  }

  .item-header {
    display: inline;
  }

  .item-title {
    font-size: var(--view-title-size);
    font-weight: var(--view-title-weight);
    color: var(--color-text);
    line-height: var(--line-height-snug);
    transition: color var(--view-transition);
  }

  a.item-title {
    text-decoration: none;
    background: none;
  }

  a.item-title:hover {
    color: var(--color-accent);
  }

  .item-context {
    font-size: var(--view-meta-size);
    margin-top: var(--space-1);
  }

  .context-primary {
    color: var(--color-text-secondary);
  }

  .context-secondary {
    color: var(--color-text-muted);
  }

  .item-authors {
    font-size: var(--view-meta-size);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
  }

  .item-description {
    font-size: var(--view-description-size);
    color: var(--view-description-color);
    margin: var(--space-2) 0 0 0;
    line-height: var(--line-height-relaxed);
  }

  .item-tags {
    margin-top: var(--space-2);
  }

  /* Inline links - compact, flows with title text */
  .item-links-inline {
    display: inline;
    margin-left: var(--space-2);
    white-space: nowrap;
  }

  .item-links-inline :global(.action-link) {
    margin-right: var(--space-3);
  }

  .item-links-inline :global(.action-link:last-child) {
    margin-right: 0;
  }

  /* ======================
     MOBILE
     ====================== */
  @media (max-width: 600px) {
    .timeline-view--minimal .timeline-item {
      grid-template-columns: 1fr;
      gap: var(--space-1);
    }

    .timeline-view--minimal .date-col {
      text-align: left;
      order: -1;
    }

    .timeline-view--minimal .dot-col {
      display: none;
    }

    .timeline-view--classic .timeline-item,
    .timeline-view--strip .timeline-item {
      gap: var(--space-3);
    }

    .timeline-view--classic .timeline-list::before {
      left: 5px;
    }

    .timeline-view--classic .dot-wrapper {
      width: 12px;
    }

    .timeline-view--classic .timeline-dot {
      width: 12px;
      height: 12px;
      border-width: 2px;
    }

    /* Alternating collapses to left-aligned on mobile */
    .timeline-view--alternating .timeline-list::before {
      left: 5px;
      transform: none;
    }

    .timeline-view--alternating .timeline-item[data-position="left"],
    .timeline-view--alternating .timeline-item[data-position="right"] {
      padding-left: var(--space-8);
      padding-right: 0;
    }

    .timeline-view--alternating .timeline-item[data-position="left"] .item-content,
    .timeline-view--alternating .timeline-item[data-position="right"] .item-content {
      text-align: left;
    }

    .timeline-view--alternating .timeline-item[data-position="left"] .dot-wrapper,
    .timeline-view--alternating .timeline-item[data-position="right"] .dot-wrapper {
      position: absolute;
      left: 0;
      transform: translateX(-3px);
    }

    .timeline-view--alternating .timeline-item[data-position="left"] .item-header,
    .timeline-view--alternating .timeline-item[data-position="right"] .item-header {
      text-align: left;
    }

    .timeline-view--alternating .timeline-item[data-position="left"] .item-context,
    .timeline-view--alternating .timeline-item[data-position="right"] .item-context {
      text-align: left;
    }

    .timeline-view--alternating .timeline-item[data-position="left"] .item-links,
    .timeline-view--alternating .timeline-item[data-position="right"] .item-links {
      justify-content: flex-start;
    }

    .timeline-view--alternating .dot-wrapper {
      width: 12px;
    }

    .timeline-view--alternating .timeline-dot {
      width: 12px;
      height: 12px;
      border-width: 2px;
    }
  }

  /* ======================
     ANIMATIONS
     ====================== */
  @media (prefers-reduced-motion: no-preference) {
    .timeline-group {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }

    .timeline-group[data-animate="visible"] {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.setAttribute('data-animate', 'visible');
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.1, rootMargin: '0px 0px -50px 0px' }
  );

  document.querySelectorAll('.timeline-group[data-animate]').forEach((el) => {
    observer.observe(el);
  });
</script>
