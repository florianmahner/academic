---
/**
 * ListLayout Component
 * A flexible, Tufte-inspired list layout for displaying content collections
 * Supports grouping, thumbnails, metadata, tags, and action links
 *
 * Accepts Astro content collection entries and transforms them internally
 */

export interface ListItem {
  title: string;
  slug: string;
  description?: string;
  thumbnail?: string;
  date?: Date | string;
  venue?: string;
  category?: string;
  status?: string;
  tags?: string[];
  links?: {
    pdf?: string;
    html?: string;
    code?: string;
    website?: string;
    demo?: string;
  };
  [key: string]: any;
}

export interface ListLayoutConfig {
  showThumbnail?: boolean;
  thumbnailSize?: 'small' | 'medium';
  groupBy?: 'year' | 'category' | 'status' | 'none';
  fields?: ('description' | 'tags' | 'links' | 'date' | 'venue' | 'category')[];
  compact?: boolean;
}

interface Props {
  entries: any[];          // Astro content collection entries
  config?: ListLayoutConfig;
  collection?: string;     // Collection name for generating URLs
  class?: string;
}

const {
  entries = [],
  config = {},
  collection = '',
  class: className,
} = Astro.props;

// Transform Astro content collection entries to ListItem format
const items: ListItem[] = entries.map(entry => ({
  title: entry.data.title,
  slug: entry.slug,
  description: entry.data.description,
  thumbnail: entry.data.preview || entry.data.image || entry.data.thumbnail,
  date: entry.data.date || entry.data.year,
  venue: entry.data.venue || entry.data.journal || entry.data.booktitle || entry.data.event,
  category: entry.data.category || entry.data.type,
  status: entry.data.status,
  tags: entry.data.tags || entry.data.technologies,
  links: {
    pdf: entry.data.pdf,
    html: entry.data.html,
    code: entry.data.code || entry.data.github,
    website: entry.data.url || entry.data.website,
    demo: entry.data.demo,
  },
  ...entry.data,
}));

const {
  showThumbnail = true,
  thumbnailSize = 'medium',
  groupBy = 'year',
  fields = ['description', 'tags', 'links', 'date'],
  compact = false,
} = config;

// Helper to extract year from date
function getYear(date: Date | string | undefined): number {
  if (!date) return new Date().getFullYear();
  const d = typeof date === 'string' ? new Date(date) : date;
  return d.getFullYear();
}

// Group items based on groupBy setting
function groupItems(items: ListItem[], groupBy: string): Record<string, ListItem[]> {
  const groups: Record<string, ListItem[]> = {};

  items.forEach(item => {
    let key: string;

    switch (groupBy) {
      case 'year':
        key = getYear(item.date).toString();
        break;
      case 'category':
        key = item.category || 'Uncategorized';
        break;
      case 'status':
        key = item.status || 'No Status';
        break;
      case 'none':
      default:
        key = 'all';
        break;
    }

    if (!groups[key]) {
      groups[key] = [];
    }
    groups[key].push(item);
  });

  return groups;
}

const grouped = groupItems(items, groupBy);
const groupKeys = Object.keys(grouped).sort((a, b) => {
  // Sort years descending, others ascending
  if (groupBy === 'year') {
    return Number(b) - Number(a);
  }
  return a.localeCompare(b);
});

const shouldShowField = (field: string) => fields.includes(field as any);
---

<div class:list={['list-layout', className, { compact }]}>
  {groupBy === 'none' ? (
    <div class="list-items" data-animate="stagger">
      {grouped['all']?.map((item) => (
        <article class="list-item" data-thumbnail-size={thumbnailSize}>
          {showThumbnail && item.thumbnail && (
            <div class="item-thumbnail">
              <img
                src={item.thumbnail}
                alt={item.title}
                loading="lazy"
                decoding="async"
              />
            </div>
          )}
          <div class="item-content">
            <div class="item-header">
              <h3 class="item-title">
                {item.links?.html || item.links?.website ? (
                  <a href={item.links.html || item.links.website} target="_blank" rel="noopener noreferrer">
                    {item.title}
                  </a>
                ) : collection ? (
                  <a href={`/${collection}/${item.slug}`}>
                    {item.title}
                  </a>
                ) : (
                  item.title
                )}
              </h3>
              {(shouldShowField('date') || shouldShowField('venue') || shouldShowField('category')) && (
                <div class="item-meta">
                  {shouldShowField('venue') && item.venue && (
                    <span class="meta-venue">{item.venue}</span>
                  )}
                  {shouldShowField('category') && item.category && (
                    <span class="meta-category">{item.category}</span>
                  )}
                  {shouldShowField('date') && item.date && (
                    <span class="meta-date">
                      {typeof item.date === 'string' ? item.date : item.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' })}
                    </span>
                  )}
                </div>
              )}
            </div>
            {!compact && shouldShowField('description') && item.description && (
              <p class="item-description">{item.description}</p>
            )}
            {shouldShowField('tags') && item.tags && item.tags.length > 0 && (
              <div class="item-tags">
                {item.tags.map((tag, i) => (
                  <>
                    <span class="tag">{tag}</span>
                    {i < item.tags.length - 1 && <span class="tag-separator">·</span>}
                  </>
                ))}
              </div>
            )}
            {shouldShowField('links') && item.links && (
              <div class="item-links">
                {item.links.pdf && (
                  <a href={item.links.pdf} class="item-link" target="_blank" rel="noopener noreferrer">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    PDF
                  </a>
                )}
                {item.links.html && (
                  <a href={item.links.html} class="item-link" target="_blank" rel="noopener noreferrer">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="2" y1="12" x2="22" y2="12"></line>
                      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    Web
                  </a>
                )}
                {item.links.code && (
                  <a href={item.links.code} class="item-link" target="_blank" rel="noopener noreferrer">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="16 18 22 12 16 6"></polyline>
                      <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                    Code
                  </a>
                )}
                {item.links.website && (
                  <a href={item.links.website} class="item-link" target="_blank" rel="noopener noreferrer">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="2" y1="12" x2="22" y2="12"></line>
                      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    Website
                  </a>
                )}
                {item.links.demo && (
                  <a href={item.links.demo} class="item-link" target="_blank" rel="noopener noreferrer">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    Demo
                  </a>
                )}
              </div>
            )}
          </div>
        </article>
      ))}
    </div>
  ) : (
    groupKeys.map((groupKey) => (
      <section class="group-section" data-animate="fade-up">
        <h2 class="group-label">{groupKey}</h2>
        <div class="list-items" data-animate="stagger">
          {grouped[groupKey].map((item) => (
            <article class="list-item" data-thumbnail-size={thumbnailSize}>
              {showThumbnail && item.thumbnail && (
                <div class="item-thumbnail">
                  <img
                    src={item.thumbnail}
                    alt={item.title}
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              )}
              <div class="item-content">
                <div class="item-header">
                  <h3 class="item-title">
                    {item.links?.html || item.links?.website ? (
                      <a href={item.links.html || item.links.website} target="_blank" rel="noopener noreferrer">
                        {item.title}
                      </a>
                    ) : collection ? (
                      <a href={`/${collection}/${item.slug}`}>
                        {item.title}
                      </a>
                    ) : (
                      item.title
                    )}
                  </h3>
                  {(shouldShowField('date') || shouldShowField('venue') || shouldShowField('category')) && (
                    <div class="item-meta">
                      {shouldShowField('venue') && item.venue && (
                        <span class="meta-venue">{item.venue}</span>
                      )}
                      {shouldShowField('category') && item.category && (
                        <span class="meta-category">{item.category}</span>
                      )}
                      {shouldShowField('date') && item.date && groupBy !== 'year' && (
                        <span class="meta-date">
                          {typeof item.date === 'string' ? item.date : item.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' })}
                        </span>
                      )}
                    </div>
                  )}
                </div>
                {!compact && shouldShowField('description') && item.description && (
                  <p class="item-description">{item.description}</p>
                )}
                {shouldShowField('tags') && item.tags && item.tags.length > 0 && (
                  <div class="item-tags">
                    {item.tags.map((tag, i) => (
                      <>
                        <span class="tag">{tag}</span>
                        {i < item.tags.length - 1 && <span class="tag-separator">·</span>}
                      </>
                    ))}
                  </div>
                )}
                {shouldShowField('links') && item.links && (
                  <div class="item-links">
                    {item.links.pdf && (
                      <a href={item.links.pdf} class="item-link" target="_blank" rel="noopener noreferrer">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                          <polyline points="7 10 12 15 17 10"></polyline>
                          <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        PDF
                      </a>
                    )}
                    {item.links.html && (
                      <a href={item.links.html} class="item-link" target="_blank" rel="noopener noreferrer">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"></circle>
                          <line x1="2" y1="12" x2="22" y2="12"></line>
                          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                        Web
                      </a>
                    )}
                    {item.links.code && (
                      <a href={item.links.code} class="item-link" target="_blank" rel="noopener noreferrer">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="16 18 22 12 16 6"></polyline>
                          <polyline points="8 6 2 12 8 18"></polyline>
                        </svg>
                        Code
                      </a>
                    )}
                    {item.links.website && (
                      <a href={item.links.website} class="item-link" target="_blank" rel="noopener noreferrer">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"></circle>
                          <line x1="2" y1="12" x2="22" y2="12"></line>
                          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                        Website
                      </a>
                    )}
                    {item.links.demo && (
                      <a href={item.links.demo} class="item-link" target="_blank" rel="noopener noreferrer">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        Demo
                      </a>
                    )}
                  </div>
                )}
              </div>
            </article>
          ))}
        </div>
      </section>
    ))
  )}
</div>

<style>
  /* Container */
  .list-layout {
    width: 100%;
  }

  /* Group sections */
  .group-section {
    margin-bottom: var(--space-12);
  }

  .group-section:first-child {
    margin-top: 0;
  }

  .group-label {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-muted);
    margin-top: 0;
    margin-bottom: var(--space-4);
    font-family: var(--font-body);
  }

  .list-items {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  /* List item card */
  .list-item {
    display: grid;
    gap: var(--space-5);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    border-left: 2px solid transparent;
  }

  /* Thumbnail size variants */
  .list-item[data-thumbnail-size="small"] {
    grid-template-columns: 100px 1fr;
  }

  .list-item[data-thumbnail-size="medium"] {
    grid-template-columns: 140px 1fr;
  }

  /* No thumbnail */
  .list-item:not(:has(.item-thumbnail)) {
    grid-template-columns: 1fr;
  }

  @media (hover: hover) {
    .list-item:hover {
      border-left-color: var(--color-accent);
    }
  }

  /* Thumbnail */
  .item-thumbnail {
    flex-shrink: 0;
    overflow: hidden;
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    aspect-ratio: 3 / 2;
  }

  [data-thumbnail-size="small"] .item-thumbnail {
    width: 100px;
    height: 66px;
  }

  [data-thumbnail-size="medium"] .item-thumbnail {
    width: 140px;
    height: 90px;
  }

  .item-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Content */
  .item-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    min-width: 0;
  }

  .item-header {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  /* Title */
  .item-title {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    font-style: normal;
    margin: 0;
    line-height: var(--line-height-snug);
  }

  .item-title a {
    color: var(--color-text);
    background: none;
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .item-title a:hover {
    color: var(--color-accent);
  }

  /* Meta */
  .item-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .meta-venue {
    font-size: var(--font-size-xs);
    font-family: var(--font-ui);
    color: var(--color-accent);
    font-weight: var(--font-weight-medium);
  }

  .meta-category {
    font-size: var(--font-size-xs);
    font-family: var(--font-ui);
    color: var(--color-text-muted);
    font-weight: var(--font-weight-medium);
  }

  .meta-date {
    font-size: var(--font-size-xs);
    font-family: var(--font-mono);
    color: var(--color-text-muted);
  }

  /* Description */
  .item-description {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin: 0;
    line-height: var(--line-height-relaxed);
  }

  .compact .item-description {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Tags */
  .item-tags {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  .tag {
    font-family: var(--font-ui);
  }

  .tag-separator {
    color: var(--color-text-muted);
    opacity: 0.5;
  }

  /* Links */
  .item-links {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
  }

  .item-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--font-size-sm);
    font-family: var(--font-ui);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    background: none;
    text-decoration: none;
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    transition: all var(--transition-fast);
  }

  .item-link:hover {
    color: var(--color-accent);
    border-color: var(--color-accent);
    background-color: rgba(196, 30, 58, 0.05);
  }

  [data-theme="dark"] .item-link:hover {
    background-color: rgba(255, 77, 106, 0.1);
  }

  /* Responsive */
  @media (max-width: 600px) {
    .list-item[data-thumbnail-size="small"],
    .list-item[data-thumbnail-size="medium"] {
      grid-template-columns: 1fr;
      gap: var(--space-3);
    }

    .item-thumbnail {
      width: 100% !important;
      height: 120px !important;
    }

    .item-links {
      gap: var(--space-2);
    }

    .item-link {
      font-size: var(--font-size-xs);
      padding: var(--space-1) var(--space-2);
    }
  }
</style>
