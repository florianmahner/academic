---
/**
 * CardsLayout - Academic card grid component
 *
 * A refined card grid that emphasizes typography and content over visual flourishes.
 * Designed for academic websites with Tufte-inspired aesthetics.
 *
 * Accepts Astro content collection entries and transforms them internally
 */

interface CardItem {
  title: string;
  slug: string;
  description?: string;
  image?: string;
  tags?: string[];
  status?: string;
  links?: Array<{ label: string; url: string }>;
  date?: string | Date;
}

interface Props {
  entries: any[];          // Astro content collection entries
  config?: {
    style?: 'image' | 'text' | 'compact';
    columns?: number | 'auto';
    aspectRatio?: '16:9' | '4:3' | '1:1' | '3:2';
    showDescription?: boolean;
    showTags?: boolean;
    gap?: 'small' | 'medium' | 'large';
  };
  collection?: string;     // Collection name for generating URLs
}

const {
  entries = [],
  config = {},
  collection = '',
} = Astro.props;

const {
  style = 'image',
  columns = 'auto',
  aspectRatio = '16:9',
  showDescription = true,
  showTags = true,
  gap = 'medium',
} = config;

// Transform Astro content collection entries to CardItem format
const items: CardItem[] = entries.map(entry => {
  const links: Array<{ label: string; url: string }> = [];
  if (entry.data.github) links.push({ label: 'GitHub', url: entry.data.github });
  if (entry.data.url || entry.data.website) links.push({ label: 'Website', url: entry.data.url || entry.data.website });
  if (entry.data.demo) links.push({ label: 'Demo', url: entry.data.demo });
  if (entry.data.slides) links.push({ label: 'Slides', url: entry.data.slides });
  if (entry.data.video) links.push({ label: 'Video', url: entry.data.video });

  return {
    title: entry.data.title,
    slug: entry.slug,
    description: entry.data.description,
    image: entry.data.image || entry.data.preview || entry.data.thumbnail,
    tags: entry.data.tags || entry.data.technologies,
    status: entry.data.status || (entry.data.draft ? 'draft' : 'published'),
    links,
    date: entry.data.date,
  };
});

// Calculate aspect ratio value
const aspectRatioMap = {
  '16:9': '56.25%',
  '4:3': '75%',
  '1:1': '100%',
  '3:2': '66.67%',
};

// Grid column configuration
const gridColumns = columns === 'auto'
  ? 'repeat(auto-fill, minmax(280px, 1fr))'
  : `repeat(${columns}, 1fr)`;

// Adjust for compact style
const compactColumns = style === 'compact'
  ? 'repeat(auto-fill, minmax(220px, 1fr))'
  : gridColumns;

// Gap sizes
const gapSizes = {
  small: '1rem',
  medium: '1.5rem',
  large: '2rem',
};

// Status indicator colors
const statusColors: Record<string, string> = {
  draft: '#e0a800',
  published: '#2e7d32',
  archived: '#757575',
  active: '#10b981',
  completed: '#6b7280',
  featured: '#c41e3a',
};
---

<div class={`cards-layout cards-layout--${style}`} data-columns={columns}>
  {items.map((item) => (
    <article class="card">
      {/* Link to detail page */}
      {collection && item.slug && (
        <a href={`/${collection}/${item.slug}`} class="card__link-overlay" aria-label={item.title}></a>
      )}
      {item.status && (
        <div class="card__status" data-status={item.status}>
          <span class="card__status-dot" style={`background-color: ${statusColors[item.status]}`}></span>
          <span class="card__status-label">{item.status}</span>
        </div>
      )}

      {style === 'image' && item.image && (
        <div class="card__image-wrapper">
          <img src={item.image} alt={item.title} class="card__image" loading="lazy" />
        </div>
      )}

      {style === 'compact' && item.image && (
        <div class="card__thumbnail">
          <img src={item.image} alt={item.title} loading="lazy" />
        </div>
      )}

      <div class="card__content">
        <h3 class="card__title">{item.title}</h3>

        {item.date && (
          <time class="card__date" datetime={item.date}>
            {new Date(item.date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
        )}

        {showDescription && item.description && (
          <p class="card__description">{item.description}</p>
        )}

        {showTags && item.tags && item.tags.length > 0 && (
          <div class="card__tags">
            {item.tags.map((tag, index) => (
              <Fragment>
                <span class="card__tag">{tag}</span>
                {index < item.tags.length - 1 && <span class="card__tag-separator">Â·</span>}
              </Fragment>
            ))}
          </div>
        )}

        {item.links && item.links.length > 0 && (
          <div class="card__links">
            {item.links.map((link) => (
              <a href={link.url} class="card__link">
                {link.label}
              </a>
            ))}
          </div>
        )}
      </div>
    </article>
  ))}
</div>

<style define:vars={{
  gridColumns: compactColumns,
  gapSize: gapSizes[gap],
  aspectRatio: aspectRatioMap[aspectRatio]
}}>
  .cards-layout {
    display: grid;
    grid-template-columns: var(--gridColumns);
    gap: var(--gapSize);
    margin: 2rem 0;
  }

  /* Card Base Styles */
  .card {
    position: relative;
    background: var(--bg-color, #ffffff);
    border: 1px solid var(--border-color, #d0d0d0);
    border-radius: 4px;
    transition: transform 0.2s ease, border-color 0.2s ease;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Link overlay for entire card */
  .card__link-overlay {
    position: absolute;
    inset: 0;
    z-index: 1;
    background: none;
    text-decoration: none;
  }

  .card__link-overlay:focus-visible {
    outline: 2px solid var(--color-accent, #c41e3a);
    outline-offset: 2px;
  }

  .card:hover {
    transform: translateY(-2px);
    border-color: var(--border-hover-color, #999999);
  }

  /* Status Indicator */
  .card__status {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.625rem;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 3px;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    z-index: 10;
  }

  .card__status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }

  .card__status-label {
    color: var(--text-muted, #666666);
    font-weight: 500;
  }

  /* Image Cards */
  .cards-layout--image .card__image-wrapper {
    position: relative;
    width: 100%;
    padding-bottom: var(--aspectRatio);
    overflow: hidden;
    background: var(--bg-muted, #f5f5f5);
  }

  .cards-layout--image .card__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Compact Cards */
  .cards-layout--compact .card {
    flex-direction: row;
    align-items: flex-start;
    padding: 0.75rem;
  }

  .cards-layout--compact .card__thumbnail {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: 3px;
    overflow: hidden;
    background: var(--bg-muted, #f5f5f5);
    margin-right: 0.875rem;
  }

  .cards-layout--compact .card__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cards-layout--compact .card__content {
    padding: 0;
    flex: 1;
    min-width: 0;
  }

  .cards-layout--compact .card__title {
    font-size: var(--font-size-sm);
    margin-bottom: 0.25rem;
  }

  .cards-layout--compact .card__description {
    font-size: var(--font-size-xs);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Card Content */
  .card__content {
    padding: 1.25rem;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .cards-layout--text .card__content {
    padding: 1.5rem;
  }

  .card__title {
    margin: 0 0 0.5rem 0;
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    line-height: var(--line-height-snug);
    color: var(--text-primary, #1a1a1a);
    letter-spacing: -0.01em;
  }

  .card__date {
    display: block;
    margin-bottom: 0.625rem;
    font-size: var(--font-size-xs);
    color: var(--text-muted, #666666);
    font-style: italic;
  }

  .card__description {
    margin: 0 0 1rem 0;
    font-size: var(--font-size-sm);
    line-height: var(--line-height-normal);
    color: var(--text-secondary, #4a4a4a);
    flex: 1;
  }

  .cards-layout--text .card__description {
    font-size: var(--font-size-sm);
    line-height: var(--line-height-normal);
  }

  /* Tags */
  .card__tags {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.375rem;
    margin-bottom: 1rem;
    font-size: var(--font-size-xs);
    color: var(--text-muted, #666666);
  }

  .card__tag {
    font-style: italic;
  }

  .card__tag-separator {
    opacity: 0.5;
    margin: 0 0.125rem;
  }

  /* Links */
  .card__links {
    display: flex;
    flex-wrap: wrap;
    gap: 0.875rem;
    margin-top: auto;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-light, #e8e8e8);
  }

  .card__link {
    font-size: var(--font-size-xs);
    color: var(--link-color, #2563eb);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
    transition: color 0.15s ease;
  }

  .card__link:hover {
    color: var(--link-hover-color, #1d4ed8);
    text-decoration: underline;
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .cards-layout {
      grid-template-columns: 1fr;
      gap: 1.25rem;
    }

    .cards-layout--compact {
      grid-template-columns: 1fr;
    }

    .card__content {
      padding: 1rem;
    }

    .card__title {
      font-size: var(--font-size-base);
    }
  }

  /* Dark Mode Support */
  @media (prefers-color-scheme: dark) {
    .card {
      background: var(--bg-color, #1a1a1a);
      border-color: var(--border-color, #404040);
    }

    .card:hover {
      border-color: var(--border-hover-color, #666666);
    }

    .card__title {
      color: var(--text-primary, #e8e8e8);
    }

    .card__description {
      color: var(--text-secondary, #b8b8b8);
    }

    .card__date,
    .card__tags {
      color: var(--text-muted, #999999);
    }

    .card__links {
      border-top-color: var(--border-light, #2a2a2a);
    }

    .card__status {
      background: rgba(26, 26, 26, 0.95);
    }

    .cards-layout--image .card__image-wrapper,
    .cards-layout--compact .card__thumbnail {
      background: var(--bg-muted, #2a2a2a);
    }
  }

  /* Print Styles */
  @media print {
    .cards-layout {
      display: block;
    }

    .card {
      break-inside: avoid;
      margin-bottom: 1.5rem;
      box-shadow: none;
    }

    .card:hover {
      transform: none;
    }

    .card__link {
      color: #000000;
      text-decoration: underline;
    }
  }
</style>
