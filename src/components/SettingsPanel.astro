---
/**
 * Unified Settings Panel (Development Only)
 *
 * Floating panel to customize:
 * - Typography presets (fonts + colors)
 * - Accent color (independent of preset)
 * - Navigation mode (floating, sidebar, inline)
 *
 * Only visible in development mode.
 */
import { typographyPresets, DEFAULT_PRESET_ID } from '../lib/typography-presets';

// Curated accent colors - distinct and visually pleasing
const accentColors = [
  { id: 'crimson', name: 'Crimson', light: '#c41e3a', dark: '#ff4d6a' },
  { id: 'rose', name: 'Rose', light: '#e11d48', dark: '#fb7185' },
  { id: 'amber', name: 'Amber', light: '#d97706', dark: '#fbbf24' },
  { id: 'emerald', name: 'Emerald', light: '#059669', dark: '#34d399' },
  { id: 'cyan', name: 'Teal', light: '#0891b2', dark: '#22d3ee' },
  { id: 'blue', name: 'Blue', light: '#2563eb', dark: '#60a5fa' },
  { id: 'indigo', name: 'Indigo', light: '#4f46e5', dark: '#818cf8' },
  { id: 'violet', name: 'Violet', light: '#7c3aed', dark: '#a78bfa' },
  { id: 'navy', name: 'Navy', light: '#1e3a5f', dark: '#93c5fd' },
  { id: 'slate', name: 'Slate', light: '#475569', dark: '#cbd5e1' },
];

const navModes = [
  {
    id: 'floating',
    name: 'Floating Pill',
    description: 'Safari-style bottom nav',
  },
  {
    id: 'sidebar',
    name: 'Left Sidebar',
    description: 'Fixed sidebar navigation',
  },
  {
    id: 'inline',
    name: 'Inline Header',
    description: 'Simple top header',
  },
];
---

<div id="settings-panel" class="settings-panel">
  <button id="settings-toggle" class="toggle-btn" aria-label="Toggle settings">
    <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="3"></circle>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
    </svg>
  </button>

  <div id="settings-dropdown" class="dropdown" hidden>
    <div class="dropdown-header">
      <span class="dropdown-title">Settings</span>
      <button id="settings-close" class="close-btn" aria-label="Close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Theme & Color Section (combined) -->
    <div class="section">
      <div class="section-row">
        <div class="section-col">
          <div class="section-title">Theme</div>
          <fieldset class="theme-toggle-group">
            <legend class="sr-only">Color Theme</legend>
            <button class="theme-option" data-theme="light">
              <svg aria-hidden="true" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
              <span>Light</span>
            </button>
            <button class="theme-option" data-theme="dark">
              <svg aria-hidden="true" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
              <span>Dark</span>
            </button>
          </fieldset>
        </div>
      </div>

      <div class="section-title" style="margin-top: 8px;">Accent</div>
      <fieldset class="color-grid">
        <legend class="sr-only">Accent Color</legend>
        {accentColors.map(color => (
          <button
            class="color-option"
            data-color-id={color.id}
            data-color-light={color.light}
            data-color-dark={color.dark}
            title={color.name}
            aria-label={color.name}
          >
            <span class="color-dot" style={`background: ${color.light}`}></span>
          </button>
        ))}
      </fieldset>
    </div>

    <!-- Typography Section -->
    <div class="section">
      <div class="section-title">Typography</div>
      <fieldset class="option-list">
        <legend class="sr-only">Typography Style</legend>
        {typographyPresets.map(preset => (
          <button
            class="option-btn typography-option"
            data-preset-id={preset.id}
            data-fonts={JSON.stringify(preset.fonts)}
            data-colors={JSON.stringify(preset.colors)}
            data-styles={JSON.stringify(preset.styles)}
          >
            <span class="option-name">{preset.name}</span>
            <span class="option-desc">{preset.description}</span>
          </button>
        ))}
      </fieldset>
    </div>

    <!-- Navigation Mode Section -->
    <div class="section">
      <div class="section-title">Layout</div>
      <fieldset class="option-list nav-list">
        <legend class="sr-only">Navigation Style</legend>
        {navModes.map(mode => (
          <button
            class="option-btn nav-option"
            data-nav-mode={mode.id}
          >
            <span class="option-name">{mode.name}</span>
            <span class="option-desc">{mode.description}</span>
          </button>
        ))}
      </fieldset>
    </div>

    <div class="dropdown-footer">
      <span class="footer-label">
        <span id="current-typography">-</span> · <span id="current-color">-</span> · <span id="current-nav">-</span> · <span id="current-theme">-</span>
      </span>
    </div>
  </div>
</div>

<style>
  .settings-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    font-family: system-ui, -apple-system, sans-serif;
    font-size: 13px;
  }

  .toggle-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: transparent;
    color: #a1a1aa;
    border: 1px solid #e4e4e7;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s, border-color 0.2s;
  }

  .toggle-btn:hover {
    color: #71717a;
    border-color: #a1a1aa;
  }

  [data-theme="dark"] .toggle-btn {
    border-color: #3f3f46;
    color: #71717a;
  }

  [data-theme="dark"] .toggle-btn:hover {
    color: #a1a1aa;
    border-color: #52525b;
  }

  .dropdown {
    position: absolute;
    bottom: 46px;
    right: 0;
    width: 280px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    overflow: hidden;
    border: 1px solid #e4e4e7;
  }

  [data-theme="dark"] .dropdown {
    background: #27272a;
    border-color: #3f3f46;
  }

  .dropdown[hidden] {
    display: none;
  }

  .dropdown-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid #e4e4e7;
  }

  [data-theme="dark"] .dropdown-header {
    border-color: #3f3f46;
  }

  .dropdown-title {
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #71717a;
  }

  .close-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #71717a;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    color: #18181b;
  }

  [data-theme="dark"] .close-btn:hover {
    color: #fafafa;
  }

  .section {
    border-bottom: 1px solid #e4e4e7;
  }

  .section:last-of-type {
    border-bottom: none;
  }

  [data-theme="dark"] .section {
    border-color: #3f3f46;
  }

  .section-title {
    padding: 10px 16px 6px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #a1a1aa;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
  .option-list {
    border: none;
    margin: 0;
    max-height: 180px;
    overflow-y: auto;
    padding: 0 8px 8px;
  }

  .option-btn {
    width: 100%;
    text-align: left;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 8px;
    padding: 8px 10px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 2px;
    transition: all 0.15s;
  }

  .option-btn:hover {
    background: #f4f4f5;
  }

  [data-theme="dark"] .option-btn:hover {
    background: #3f3f46;
  }

  .option-btn.active {
    background: #f4f4f5;
    border-color: #a1a1aa;
  }

  [data-theme="dark"] .option-btn.active {
    background: #3f3f46;
    border-color: #71717a;
  }

  .option-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
  }

  .option-name {
    font-weight: 500;
    color: #18181b;
    font-size: 12px;
  }

  [data-theme="dark"] .option-name {
    color: #fafafa;
  }

  .option-desc {
    font-size: 10px;
    color: #71717a;
  }

  .dropdown-footer {
    padding: 8px 16px;
    border-top: 1px solid #e4e4e7;
    background: #fafafa;
  }

  [data-theme="dark"] .dropdown-footer {
    border-color: #3f3f46;
    background: #1f1f23;
  }

  .footer-label {
    font-size: 10px;
    color: #71717a;
  }

  .theme-toggle-group {
    border: none;
    margin: 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 0 8px 8px;
  }

  .theme-option {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    color: #18181b;
    transition: all 0.15s;
  }

  .theme-option:hover {
    background: #f4f4f5;
  }

  [data-theme="dark"] .theme-option {
    color: #fafafa;
  }

  [data-theme="dark"] .theme-option:hover {
    background: #3f3f46;
  }

  .theme-option.active {
    background: #f4f4f5;
    border-color: #a1a1aa;
  }

  [data-theme="dark"] .theme-option.active {
    background: #3f3f46;
    border-color: #71717a;
  }

  /* Color Grid */
  .color-grid {
    border: none;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
    padding: 0 12px 12px;
  }

  .color-option {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: transparent;
    border: 2px solid transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    padding: 0;
  }

  .color-option:hover {
    background: #f4f4f5;
    transform: scale(1.1);
  }

  [data-theme="dark"] .color-option:hover {
    background: #3f3f46;
  }

  .color-option.active {
    border-color: #a1a1aa;
    background: #f4f4f5;
  }

  [data-theme="dark"] .color-option.active {
    border-color: #71717a;
    background: #3f3f46;
  }

  .color-dot {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  [data-theme="dark"] .color-dot {
    border-color: rgba(255, 255, 255, 0.1);
  }

  /* Navigation list - more compact */
  .nav-list {
    max-height: 120px;
  }
</style>

<script>
  function initSettingsPanel() {
    // Get default preset from localStorage or data attribute (set by config)
    const getDefaultPresetId = () => {
      const stored = localStorage.getItem('typography-preset');
      if (stored) return stored;
      // Fallback to data attribute set by config
      const html = document.documentElement;
      return html.getAttribute('data-typography') || 'editorial-newsreader';
    };
    const toggle = document.getElementById('settings-toggle');
    const dropdown = document.getElementById('settings-dropdown');
    const close = document.getElementById('settings-close');
    const navOptions = document.querySelectorAll('.nav-option');
    const typographyOptions = document.querySelectorAll('.typography-option');
    const colorOptions = document.querySelectorAll('.color-option');
    const themeOptions = document.querySelectorAll('.theme-option');
    const currentNav = document.getElementById('current-nav');
    const currentTypography = document.getElementById('current-typography');
    const currentColor = document.getElementById('current-color');
    const currentTheme = document.getElementById('current-theme');
    const html = document.documentElement;
    const body = document.body;

    // Nav mode names
    const navModeNames: Record<string, string> = {
      'floating': 'Floating',
      'sidebar': 'Sidebar',
      'inline': 'Inline',
    };

    // Get stored values
    const getStoredNavMode = () => localStorage.getItem('nav-mode') || 'sidebar';
    const getStoredPreset = () => localStorage.getItem('typography-preset') || getDefaultPresetId();
    const getStoredColor = () => localStorage.getItem('accent-color') || null;

    // Apply nav mode
    const applyNavMode = (mode: string) => {
      html.setAttribute('data-nav-mode', mode);
      body.setAttribute('data-nav-mode', mode);
      localStorage.setItem('nav-mode', mode);

      navOptions.forEach(opt => {
        const optMode = (opt as HTMLElement).dataset.navMode;
        opt.classList.toggle('active', optMode === mode);
      });

      if (currentNav) {
        currentNav.textContent = navModeNames[mode] || mode;
      }
    };

    // Font URLs for dynamic loading (must match font-loader.ts)
    const PRESET_FONT_URLS: Record<string, string> = {
      'crimson-classic': 'https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'editorial-newsreader': 'https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,500;1,6..72,300;1,6..72,400;1,6..72,500&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'modern-geist': 'https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@300;400;500;600;700&display=swap',
      'classic-playfair': 'https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&family=Lora:ital,wght@0,400;0,500;1,400&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'brutalist-space': 'https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap',
      'humanist-inter': 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'elegant-josefin': 'https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100;0,300;0,400;0,500;0,600;0,700;1,300;1,400&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'clean-roboto': 'https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,400&family=Roboto+Mono:wght@300;400;500;600;700&display=swap',
      'refined-jost': 'https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100;0,300;0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'editorial-instrument': 'https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
    };

    // Track loaded fonts to prevent duplicates
    const loadedFonts = new Set<string>();

    // Load fonts for a preset
    const loadFonts = (presetId: string): Promise<void> => {
      if (loadedFonts.has(presetId)) {
        return Promise.resolve();
      }

      const url = PRESET_FONT_URLS[presetId];
      if (!url) {
        return Promise.resolve();
      }

      return new Promise((resolve) => {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        link.onload = () => {
          loadedFonts.add(presetId);
          resolve();
        };
        link.onerror = () => resolve(); // Don't block on error
        document.head.appendChild(link);
      });
    };

    // Apply accent color
    const applyColor = (btn: Element) => {
      const colorId = btn.getAttribute('data-color-id');
      const colorLight = btn.getAttribute('data-color-light');
      const colorDark = btn.getAttribute('data-color-dark');

      if (colorLight && colorDark) {
        html.style.setProperty('--color-accent-light', colorLight);
        html.style.setProperty('--color-accent-dark', colorDark);
        localStorage.setItem('accent-color', colorId || '');
        localStorage.setItem('accent-color-light', colorLight);
        localStorage.setItem('accent-color-dark', colorDark);
      }

      colorOptions.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      if (currentColor) {
        currentColor.textContent = btn.getAttribute('title') || '-';
      }
    };

    // Apply typography preset
    const applyPreset = async (btn: Element, skipColorOverride = false) => {
      const presetId = btn.getAttribute('data-preset-id');
      const fonts = JSON.parse(btn.getAttribute('data-fonts') || '{}');
      const colors = JSON.parse(btn.getAttribute('data-colors') || '{}');
      const styles = JSON.parse(btn.getAttribute('data-styles') || '{}');

      // Load fonts FIRST before applying styles
      if (presetId) {
        await loadFonts(presetId);
      }

      html.setAttribute('data-typography', presetId || '');
      html.style.setProperty('--font-body', `"${fonts.body}", Georgia, serif`);
      html.style.setProperty('--font-heading', `"${fonts.heading}", Georgia, serif`);
      html.style.setProperty('--font-ui', `"${fonts.ui}", system-ui, sans-serif`);
      html.style.setProperty('--font-mono', `"${fonts.mono}", monospace`);
      html.style.setProperty('--heading-style', styles.headingStyle);
      html.style.setProperty('--heading-weight', styles.headingWeight);
      html.style.setProperty('--body-weight', styles.bodyWeight);

      // Only apply preset colors if no custom color is stored or skipColorOverride is false
      const storedColor = getStoredColor();
      if (!storedColor || !skipColorOverride) {
        // If no custom color, use preset colors but don't mark anything active in color grid
        if (!storedColor) {
          html.style.setProperty('--color-accent-light', colors.accentLight);
          html.style.setProperty('--color-accent-dark', colors.accentDark);
          colorOptions.forEach(b => b.classList.remove('active'));
          if (currentColor) currentColor.textContent = 'Default';
        }
      }

      localStorage.setItem('typography-preset', presetId || '');
      localStorage.setItem('typography-fonts', JSON.stringify(fonts));
      localStorage.setItem('typography-colors', JSON.stringify(colors));
      localStorage.setItem('typography-styles', JSON.stringify(styles));

      typographyOptions.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      if (currentTypography) {
        currentTypography.textContent = btn.querySelector('.option-name')?.textContent || '-';
      }
    };

    // Apply theme (light/dark)
    const applyTheme = (theme: string) => {
      html.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);

      themeOptions.forEach(opt => {
        const optTheme = (opt as HTMLElement).dataset.theme;
        opt.classList.toggle('active', optTheme === theme);
      });

      if (currentTheme) {
        currentTheme.textContent = theme === 'dark' ? 'Dark' : 'Light';
      }
    };

    // Get stored theme
    const getStoredTheme = () => {
      const stored = localStorage.getItem('theme');
      if (stored) return stored;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    // Initialize with stored values
    applyNavMode(getStoredNavMode());
    applyTheme(getStoredTheme());

    const storedPresetId = getStoredPreset();
    const storedPresetBtn = document.querySelector(`[data-preset-id="${storedPresetId}"]`);
    if (storedPresetBtn) {
      applyPreset(storedPresetBtn, true);
    }

    // Apply stored accent color if exists
    const storedColorId = getStoredColor();
    if (storedColorId) {
      const storedColorBtn = document.querySelector(`[data-color-id="${storedColorId}"]`);
      if (storedColorBtn) {
        applyColor(storedColorBtn);
      }
    } else {
      // No custom color, show "Default" in footer
      if (currentColor) currentColor.textContent = 'Default';
    }

    // Toggle dropdown
    toggle?.addEventListener('click', () => {
      const isHidden = dropdown?.hasAttribute('hidden');
      if (isHidden) {
        dropdown?.removeAttribute('hidden');
      } else {
        dropdown?.setAttribute('hidden', '');
      }
    });

    // Close dropdown
    close?.addEventListener('click', () => {
      dropdown?.setAttribute('hidden', '');
    });

    // Nav mode selection
    navOptions.forEach(opt => {
      opt.addEventListener('click', () => {
        const mode = (opt as HTMLElement).dataset.navMode;
        if (mode) applyNavMode(mode);
      });
    });

    // Typography selection (async for font loading)
    typographyOptions.forEach(btn => {
      btn.addEventListener('click', async () => await applyPreset(btn, true));
    });

    // Color selection
    colorOptions.forEach(btn => {
      btn.addEventListener('click', () => applyColor(btn));
    });

    // Theme selection
    themeOptions.forEach(opt => {
      opt.addEventListener('click', () => {
        const theme = (opt as HTMLElement).dataset.theme;
        if (theme) applyTheme(theme);
      });
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('settings-panel');
      if (panel && !panel.contains(e.target as Node)) {
        dropdown?.setAttribute('hidden', '');
      }
    });
  }

  // Initialize
  initSettingsPanel();
  document.addEventListener('astro:after-swap', initSettingsPanel);
</script>
