---
/**
 * Unified Settings Panel (Development Only)
 *
 * Mobile-first design with bottom sheet on mobile, dropdown on desktop.
 * No internal scrolling - shows all options at once.
 */
import { typographyPresets } from '../lib/typography-presets';

// Curated accent colors
const accentColors = [
  { id: 'crimson', name: 'Crimson', light: '#c41e3a', dark: '#ff4d6a' },
  { id: 'rose', name: 'Rose', light: '#e11d48', dark: '#fb7185' },
  { id: 'amber', name: 'Amber', light: '#d97706', dark: '#fbbf24' },
  { id: 'emerald', name: 'Emerald', light: '#059669', dark: '#34d399' },
  { id: 'cyan', name: 'Teal', light: '#0891b2', dark: '#22d3ee' },
  { id: 'blue', name: 'Blue', light: '#2563eb', dark: '#60a5fa' },
  { id: 'indigo', name: 'Indigo', light: '#4f46e5', dark: '#818cf8' },
  { id: 'violet', name: 'Violet', light: '#7c3aed', dark: '#a78bfa' },
  { id: 'navy', name: 'Navy', light: '#1e3a5f', dark: '#93c5fd' },
  { id: 'slate', name: 'Slate', light: '#475569', dark: '#cbd5e1' },
];

const navModes = [
  { id: 'floating', name: 'Floating' },
  { id: 'sidebar', name: 'Sidebar' },
  { id: 'inline', name: 'Header' },
];
---

<!-- Backdrop for mobile -->
<div id="settings-backdrop" class="settings-backdrop" hidden></div>

<div id="settings-panel" class="settings-panel">
  <button id="settings-toggle" class="toggle-btn" aria-label="Toggle settings">
    <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="3"></circle>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
    </svg>
  </button>

  <div id="settings-dropdown" class="dropdown" hidden>
    <!-- Drag handle for mobile -->
    <div class="drag-handle"><span></span></div>

    <div class="dropdown-header">
      <span class="dropdown-title">Settings</span>
      <button id="settings-close" class="close-btn" aria-label="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="dropdown-body">
      <!-- Theme Toggle -->
      <div class="setting-row">
        <span class="setting-label">Theme</span>
        <div class="toggle-group" role="radiogroup" aria-label="Color Theme">
          <button class="toggle-item" data-theme="light" aria-pressed="false">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </button>
          <button class="toggle-item" data-theme="dark" aria-pressed="false">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Layout Toggle -->
      <div class="setting-row">
        <span class="setting-label">Layout</span>
        <div class="toggle-group toggle-group--text" role="radiogroup" aria-label="Navigation Style">
          {navModes.map(mode => (
            <button class="toggle-item nav-option" data-nav-mode={mode.id} aria-pressed="false">
              {mode.name}
            </button>
          ))}
        </div>
      </div>

      <!-- Accent Colors -->
      <div class="setting-section">
        <span class="setting-label">Accent Color</span>
        <div class="color-grid" role="radiogroup" aria-label="Accent Color">
          {accentColors.map(color => (
            <button
              class="color-option"
              data-color-id={color.id}
              data-color-light={color.light}
              data-color-dark={color.dark}
              title={color.name}
              aria-label={color.name}
              aria-pressed="false"
            >
              <span class="color-dot" style={`--dot-color: ${color.light}`}></span>
            </button>
          ))}
        </div>
      </div>

      <!-- Typography -->
      <div class="setting-section">
        <span class="setting-label">Typography</span>
        <div class="typography-grid" role="radiogroup" aria-label="Typography Style">
          {typographyPresets.map(preset => (
            <button
              class="typo-option"
              data-preset-id={preset.id}
              data-fonts={JSON.stringify(preset.fonts)}
              data-colors={JSON.stringify(preset.colors)}
              data-styles={JSON.stringify(preset.styles)}
              aria-pressed="false"
            >
              <span class="typo-name">{preset.name}</span>
            </button>
          ))}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Backdrop for mobile */
  .settings-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    z-index: 9998;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .settings-backdrop.visible {
    opacity: 1;
  }

  .settings-backdrop[hidden] {
    display: none;
  }

  /* Panel container */
  .settings-panel {
    position: fixed;
    bottom: 16px;
    right: 16px;
    z-index: 9999;
    font-family: system-ui, -apple-system, sans-serif;
    font-size: 14px;
  }

  /* Toggle button - larger touch target */
  .toggle-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--color-bg, #fff);
    color: var(--color-text-muted, #71717a);
    border: 1px solid var(--color-border, #e4e4e7);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .toggle-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  [data-theme="dark"] .toggle-btn {
    background: #27272a;
    border-color: #3f3f46;
    color: #a1a1aa;
  }

  /* Dropdown - desktop */
  .dropdown {
    position: absolute;
    bottom: 54px;
    right: 0;
    width: 320px;
    max-width: calc(100vw - 32px);
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.15);
    border: 1px solid #e4e4e7;
    transform-origin: bottom right;
    animation: dropdownIn 0.2s ease;
  }

  @keyframes dropdownIn {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(8px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  [data-theme="dark"] .dropdown {
    background: #1c1c1e;
    border-color: #3f3f46;
  }

  .dropdown[hidden] {
    display: none;
  }

  /* Drag handle - hidden on desktop */
  .drag-handle {
    display: none;
  }

  /* Header */
  .dropdown-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px 12px;
    border-bottom: 1px solid #e4e4e7;
  }

  [data-theme="dark"] .dropdown-header {
    border-color: #3f3f46;
  }

  .dropdown-title {
    font-weight: 600;
    font-size: 15px;
    color: #18181b;
  }

  [data-theme="dark"] .dropdown-title {
    color: #fafafa;
  }

  .close-btn {
    width: 32px;
    height: 32px;
    background: none;
    border: none;
    cursor: pointer;
    color: #71717a;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.15s;
  }

  .close-btn:hover {
    background: #f4f4f5;
    color: #18181b;
  }

  [data-theme="dark"] .close-btn:hover {
    background: #3f3f46;
    color: #fafafa;
  }

  /* Body */
  .dropdown-body {
    padding: 16px 20px 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* Setting row - horizontal layout */
  .setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .setting-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .setting-label {
    font-size: 13px;
    font-weight: 500;
    color: #71717a;
    flex-shrink: 0;
  }

  /* Toggle group - segmented control style */
  .toggle-group {
    display: flex;
    background: #f4f4f5;
    border-radius: 10px;
    padding: 3px;
    gap: 2px;
  }

  [data-theme="dark"] .toggle-group {
    background: #27272a;
  }

  .toggle-item {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px 12px;
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: #71717a;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.15s;
    min-width: 44px;
  }

  .toggle-group--text .toggle-item {
    padding: 8px 14px;
  }

  .toggle-item:hover {
    color: #18181b;
  }

  [data-theme="dark"] .toggle-item:hover {
    color: #fafafa;
  }

  .toggle-item.active {
    background: #ffffff;
    color: #18181b;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  [data-theme="dark"] .toggle-item.active {
    background: #3f3f46;
    color: #fafafa;
  }

  /* Color grid */
  .color-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .color-option {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: transparent;
    border: 2px solid transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    padding: 0;
  }

  .color-option:hover {
    transform: scale(1.1);
  }

  .color-option.active {
    border-color: var(--dot-color);
    background: rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .color-option.active {
    background: rgba(255, 255, 255, 0.1);
  }

  .color-dot {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--dot-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
  }

  /* Typography grid */
  .typography-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }

  .typo-option {
    padding: 10px 12px;
    background: #f4f4f5;
    border: 2px solid transparent;
    border-radius: 10px;
    cursor: pointer;
    text-align: left;
    transition: all 0.15s;
  }

  .typo-option:hover {
    background: #e4e4e7;
  }

  [data-theme="dark"] .typo-option {
    background: #27272a;
  }

  [data-theme="dark"] .typo-option:hover {
    background: #3f3f46;
  }

  .typo-option.active {
    border-color: var(--color-accent, #2563eb);
    background: #ffffff;
  }

  [data-theme="dark"] .typo-option.active {
    background: #1c1c1e;
  }

  .typo-name {
    font-size: 12px;
    font-weight: 500;
    color: #18181b;
  }

  [data-theme="dark"] .typo-name {
    color: #fafafa;
  }

  /* ==========================================
     MOBILE STYLES - Bottom Sheet
     ========================================== */
  @media (max-width: 640px) {
    .settings-panel {
      bottom: 12px;
      right: 12px;
    }

    .dropdown {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      max-width: 100%;
      border-radius: 20px 20px 0 0;
      transform-origin: bottom center;
      animation: sheetUp 0.3s ease;
      max-height: 85vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    @keyframes sheetUp {
      from {
        opacity: 0;
        transform: translateY(100%);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .drag-handle {
      display: flex;
      justify-content: center;
      padding: 12px 0 4px;
    }

    .drag-handle span {
      width: 36px;
      height: 4px;
      background: #d1d5db;
      border-radius: 2px;
    }

    [data-theme="dark"] .drag-handle span {
      background: #52525b;
    }

    .dropdown-header {
      padding: 8px 20px 16px;
      border-bottom: none;
    }

    .dropdown-body {
      padding: 8px 20px 32px;
      gap: 24px;
    }

    .setting-row {
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }

    .toggle-group {
      width: 100%;
      justify-content: stretch;
    }

    .toggle-item {
      flex: 1;
      padding: 12px;
    }

    .color-grid {
      justify-content: flex-start;
      gap: 10px;
    }

    .color-option {
      width: 44px;
      height: 44px;
    }

    .color-dot {
      width: 28px;
      height: 28px;
    }

    .typography-grid {
      gap: 10px;
    }

    .typo-option {
      padding: 14px 16px;
    }

    .typo-name {
      font-size: 14px;
    }
  }
</style>

<script>
  function initSettingsPanel() {
    const toggle = document.getElementById('settings-toggle');
    const dropdown = document.getElementById('settings-dropdown');
    const backdrop = document.getElementById('settings-backdrop');
    const close = document.getElementById('settings-close');
    const navOptions = document.querySelectorAll('.nav-option');
    const typographyOptions = document.querySelectorAll('.typo-option');
    const colorOptions = document.querySelectorAll('.color-option');
    const themeOptions = document.querySelectorAll('[data-theme]');
    const html = document.documentElement;
    const body = document.body;

    // Check if mobile
    const isMobile = () => window.innerWidth <= 640;

    // Get default preset
    const getDefaultPresetId = () => {
      const stored = localStorage.getItem('typography-preset');
      if (stored) return stored;
      return html.getAttribute('data-typography') || 'editorial-newsreader';
    };

    // Get stored values
    const getStoredNavMode = () => localStorage.getItem('nav-mode') || 'sidebar';
    const getStoredPreset = () => localStorage.getItem('typography-preset') || getDefaultPresetId();
    const getStoredColor = () => localStorage.getItem('accent-color') || null;
    const getStoredTheme = () => {
      const stored = localStorage.getItem('theme');
      if (stored) return stored;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    // Open/close panel
    const openPanel = () => {
      dropdown?.removeAttribute('hidden');
      if (isMobile()) {
        backdrop?.removeAttribute('hidden');
        requestAnimationFrame(() => backdrop?.classList.add('visible'));
        document.body.style.overflow = 'hidden';
      }
    };

    const closePanel = () => {
      dropdown?.setAttribute('hidden', '');
      backdrop?.classList.remove('visible');
      setTimeout(() => backdrop?.setAttribute('hidden', ''), 200);
      document.body.style.overflow = '';
    };

    // Apply nav mode
    const applyNavMode = (mode: string) => {
      html.setAttribute('data-nav-mode', mode);
      body.setAttribute('data-nav-mode', mode);
      localStorage.setItem('nav-mode', mode);

      navOptions.forEach(opt => {
        const optMode = (opt as HTMLElement).dataset.navMode;
        opt.classList.toggle('active', optMode === mode);
        opt.setAttribute('aria-pressed', String(optMode === mode));
      });
    };

    // Font URLs
    const PRESET_FONT_URLS: Record<string, string> = {
      'crimson-classic': 'https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'editorial-newsreader': 'https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,500;1,6..72,300;1,6..72,400;1,6..72,500&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'modern-geist': 'https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@300;400;500;600;700&display=swap',
      'classic-playfair': 'https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&family=Lora:ital,wght@0,400;0,500;1,400&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'brutalist-space': 'https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap',
      'humanist-inter': 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'elegant-josefin': 'https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100;0,300;0,400;0,500;0,600;0,700;1,300;1,400&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'clean-roboto': 'https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,400&family=Roboto+Mono:wght@300;400;500;600;700&display=swap',
      'refined-jost': 'https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100;0,300;0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
      'editorial-instrument': 'https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap',
    };

    const loadedFonts = new Set<string>();

    const loadFonts = (presetId: string): Promise<void> => {
      if (loadedFonts.has(presetId)) return Promise.resolve();
      const url = PRESET_FONT_URLS[presetId];
      if (!url) return Promise.resolve();

      return new Promise((resolve) => {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        link.onload = () => { loadedFonts.add(presetId); resolve(); };
        link.onerror = () => resolve();
        document.head.appendChild(link);
      });
    };

    // Apply accent color
    const applyColor = (btn: Element) => {
      const colorId = btn.getAttribute('data-color-id');
      const colorLight = btn.getAttribute('data-color-light');
      const colorDark = btn.getAttribute('data-color-dark');

      if (colorLight && colorDark) {
        html.style.setProperty('--color-accent-light', colorLight);
        html.style.setProperty('--color-accent-dark', colorDark);
        localStorage.setItem('accent-color', colorId || '');
        localStorage.setItem('accent-color-light', colorLight);
        localStorage.setItem('accent-color-dark', colorDark);
      }

      colorOptions.forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-pressed', 'false');
      });
      btn.classList.add('active');
      btn.setAttribute('aria-pressed', 'true');
    };

    // Apply typography preset
    const applyPreset = async (btn: Element, skipColorOverride = false) => {
      const presetId = btn.getAttribute('data-preset-id');
      const fonts = JSON.parse(btn.getAttribute('data-fonts') || '{}');
      const colors = JSON.parse(btn.getAttribute('data-colors') || '{}');
      const styles = JSON.parse(btn.getAttribute('data-styles') || '{}');

      if (presetId) await loadFonts(presetId);

      html.setAttribute('data-typography', presetId || '');
      html.style.setProperty('--font-body', `"${fonts.body}", Georgia, serif`);
      html.style.setProperty('--font-heading', `"${fonts.heading}", Georgia, serif`);
      html.style.setProperty('--font-ui', `"${fonts.ui}", system-ui, sans-serif`);
      html.style.setProperty('--font-mono', `"${fonts.mono}", monospace`);
      html.style.setProperty('--heading-style', styles.headingStyle);
      html.style.setProperty('--heading-weight', styles.headingWeight);
      html.style.setProperty('--body-weight', styles.bodyWeight);

      const storedColor = getStoredColor();
      if (!storedColor && !skipColorOverride) {
        html.style.setProperty('--color-accent-light', colors.accentLight);
        html.style.setProperty('--color-accent-dark', colors.accentDark);
      }

      localStorage.setItem('typography-preset', presetId || '');
      localStorage.setItem('typography-fonts', JSON.stringify(fonts));
      localStorage.setItem('typography-colors', JSON.stringify(colors));
      localStorage.setItem('typography-styles', JSON.stringify(styles));

      typographyOptions.forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-pressed', 'false');
      });
      btn.classList.add('active');
      btn.setAttribute('aria-pressed', 'true');
    };

    // Apply theme
    const applyTheme = (theme: string) => {
      html.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);

      themeOptions.forEach(opt => {
        const optTheme = (opt as HTMLElement).dataset.theme;
        opt.classList.toggle('active', optTheme === theme);
        opt.setAttribute('aria-pressed', String(optTheme === theme));
      });
    };

    // Initialize states
    applyNavMode(getStoredNavMode());
    applyTheme(getStoredTheme());

    const storedPresetId = getStoredPreset();
    const storedPresetBtn = document.querySelector(`[data-preset-id="${storedPresetId}"]`);
    if (storedPresetBtn) applyPreset(storedPresetBtn, true);

    const storedColorId = getStoredColor();
    if (storedColorId) {
      const storedColorBtn = document.querySelector(`[data-color-id="${storedColorId}"]`);
      if (storedColorBtn) applyColor(storedColorBtn);
    }

    // Event listeners
    toggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = dropdown?.hasAttribute('hidden');
      if (isHidden) openPanel();
      else closePanel();
    });

    close?.addEventListener('click', closePanel);
    backdrop?.addEventListener('click', closePanel);

    navOptions.forEach(opt => {
      opt.addEventListener('click', () => {
        const mode = (opt as HTMLElement).dataset.navMode;
        if (mode) applyNavMode(mode);
      });
    });

    typographyOptions.forEach(btn => {
      btn.addEventListener('click', async () => await applyPreset(btn, true));
    });

    colorOptions.forEach(btn => {
      btn.addEventListener('click', () => applyColor(btn));
    });

    themeOptions.forEach(opt => {
      opt.addEventListener('click', () => {
        const theme = (opt as HTMLElement).dataset.theme;
        if (theme) applyTheme(theme);
      });
    });

    // Close on outside click (desktop only)
    document.addEventListener('click', (e) => {
      if (isMobile()) return;
      const panel = document.getElementById('settings-panel');
      if (panel && !panel.contains(e.target as Node)) {
        closePanel();
      }
    });

    // Handle escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !dropdown?.hasAttribute('hidden')) {
        closePanel();
      }
    });
  }

  initSettingsPanel();
  document.addEventListener('astro:after-swap', initSettingsPanel);
</script>
