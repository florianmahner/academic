---
/**
 * Unified Settings Panel (Development Only)
 *
 * Floating panel to customize:
 * - Typography presets (fonts + colors)
 * - Navigation mode (floating, sidebar, inline)
 *
 * Only visible in development mode.
 */
import { typographyPresets, DEFAULT_PRESET_ID } from '../lib/typography-presets';

const navModes = [
  {
    id: 'floating',
    name: 'Floating Pill',
    description: 'Safari-style bottom nav',
  },
  {
    id: 'sidebar',
    name: 'Left Sidebar',
    description: 'Fixed sidebar navigation',
  },
  {
    id: 'inline',
    name: 'Inline Header',
    description: 'Simple top header',
  },
];
---

<div id="settings-panel" class="settings-panel">
  <button id="settings-toggle" class="toggle-btn" aria-label="Toggle settings">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="3"></circle>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
    </svg>
  </button>

  <div id="settings-dropdown" class="dropdown" hidden>
    <div class="dropdown-header">
      <span class="dropdown-title">Settings</span>
      <button id="settings-close" class="close-btn" aria-label="Close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Navigation Mode Section -->
    <div class="section">
      <div class="section-title">Navigation</div>
      <div class="option-list">
        {navModes.map(mode => (
          <button
            class="option-btn nav-option"
            data-nav-mode={mode.id}
          >
            <span class="option-name">{mode.name}</span>
            <span class="option-desc">{mode.description}</span>
          </button>
        ))}
      </div>
    </div>

    <!-- Typography Section -->
    <div class="section">
      <div class="section-title">Typography</div>
      <div class="option-list">
        {typographyPresets.map(preset => (
          <button
            class="option-btn typography-option"
            data-preset-id={preset.id}
            data-fonts={JSON.stringify(preset.fonts)}
            data-colors={JSON.stringify(preset.colors)}
            data-styles={JSON.stringify(preset.styles)}
          >
            <div class="option-header">
              <span class="option-name">{preset.name}</span>
              <span class="color-swatch" style={`background: ${preset.colors.accentLight}`}></span>
            </div>
            <span class="option-desc">{preset.description}</span>
          </button>
        ))}
      </div>
    </div>

    <!-- Theme Section -->
    <div class="section">
      <div class="section-title">Theme</div>
      <div class="theme-toggle-group">
        <button class="theme-option" data-theme="light">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <span>Light</span>
        </button>
        <button class="theme-option" data-theme="dark">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <span>Dark</span>
        </button>
      </div>
    </div>

    <div class="dropdown-footer">
      <span class="footer-label">
        <span id="current-nav">-</span> / <span id="current-typography">-</span> / <span id="current-theme">-</span>
      </span>
    </div>
  </div>
</div>

<style>
  .settings-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    font-family: system-ui, -apple-system, sans-serif;
    font-size: 13px;
  }

  .toggle-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: transparent;
    color: #a1a1aa;
    border: 1px solid #e4e4e7;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s, border-color 0.2s;
  }

  .toggle-btn:hover {
    color: #71717a;
    border-color: #a1a1aa;
  }

  [data-theme="dark"] .toggle-btn {
    border-color: #3f3f46;
    color: #71717a;
  }

  [data-theme="dark"] .toggle-btn:hover {
    color: #a1a1aa;
    border-color: #52525b;
  }

  .dropdown {
    position: absolute;
    bottom: 46px;
    right: 0;
    width: 280px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    overflow: hidden;
    border: 1px solid #e4e4e7;
  }

  [data-theme="dark"] .dropdown {
    background: #27272a;
    border-color: #3f3f46;
  }

  .dropdown[hidden] {
    display: none;
  }

  .dropdown-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid #e4e4e7;
  }

  [data-theme="dark"] .dropdown-header {
    border-color: #3f3f46;
  }

  .dropdown-title {
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #71717a;
  }

  .close-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #71717a;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    color: #18181b;
  }

  [data-theme="dark"] .close-btn:hover {
    color: #fafafa;
  }

  .section {
    border-bottom: 1px solid #e4e4e7;
  }

  .section:last-of-type {
    border-bottom: none;
  }

  [data-theme="dark"] .section {
    border-color: #3f3f46;
  }

  .section-title {
    padding: 10px 16px 6px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #a1a1aa;
  }

  .option-list {
    max-height: 180px;
    overflow-y: auto;
    padding: 0 8px 8px;
  }

  .option-btn {
    width: 100%;
    text-align: left;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 8px;
    padding: 8px 10px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 2px;
    transition: all 0.15s;
  }

  .option-btn:hover {
    background: #f4f4f5;
  }

  [data-theme="dark"] .option-btn:hover {
    background: #3f3f46;
  }

  .option-btn.active {
    background: #f4f4f5;
    border-color: #a1a1aa;
  }

  [data-theme="dark"] .option-btn.active {
    background: #3f3f46;
    border-color: #71717a;
  }

  .option-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
  }

  .option-name {
    font-weight: 500;
    color: #18181b;
    font-size: 12px;
  }

  [data-theme="dark"] .option-name {
    color: #fafafa;
  }

  .color-swatch {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .option-desc {
    font-size: 10px;
    color: #71717a;
  }

  .dropdown-footer {
    padding: 8px 16px;
    border-top: 1px solid #e4e4e7;
    background: #fafafa;
  }

  [data-theme="dark"] .dropdown-footer {
    border-color: #3f3f46;
    background: #1f1f23;
  }

  .footer-label {
    font-size: 10px;
    color: #71717a;
  }

  .theme-toggle-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 0 8px 8px;
  }

  .theme-option {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    color: #18181b;
    transition: all 0.15s;
  }

  .theme-option:hover {
    background: #f4f4f5;
  }

  [data-theme="dark"] .theme-option {
    color: #fafafa;
  }

  [data-theme="dark"] .theme-option:hover {
    background: #3f3f46;
  }

  .theme-option.active {
    background: #f4f4f5;
    border-color: #a1a1aa;
  }

  [data-theme="dark"] .theme-option.active {
    background: #3f3f46;
    border-color: #71717a;
  }
</style>

<script>
  function initSettingsPanel() {
    // Get default preset from localStorage or data attribute (set by config)
    const getDefaultPresetId = () => {
      const stored = localStorage.getItem('typography-preset');
      if (stored) return stored;
      // Fallback to data attribute set by config
      const html = document.documentElement;
      return html.getAttribute('data-typography') || 'editorial-newsreader';
    };
    const toggle = document.getElementById('settings-toggle');
    const dropdown = document.getElementById('settings-dropdown');
    const close = document.getElementById('settings-close');
    const navOptions = document.querySelectorAll('.nav-option');
    const typographyOptions = document.querySelectorAll('.typography-option');
    const themeOptions = document.querySelectorAll('.theme-option');
    const currentNav = document.getElementById('current-nav');
    const currentTypography = document.getElementById('current-typography');
    const currentTheme = document.getElementById('current-theme');
    const html = document.documentElement;
    const body = document.body;

    // Nav mode names
    const navModeNames: Record<string, string> = {
      'floating': 'Floating',
      'sidebar': 'Sidebar',
      'inline': 'Inline',
    };

    // Get stored values
    const getStoredNavMode = () => localStorage.getItem('nav-mode') || 'sidebar';
    const getStoredPreset = () => localStorage.getItem('typography-preset') || getDefaultPresetId();

    // Apply nav mode
    const applyNavMode = (mode: string) => {
      html.setAttribute('data-nav-mode', mode);
      body.setAttribute('data-nav-mode', mode);
      localStorage.setItem('nav-mode', mode);

      navOptions.forEach(opt => {
        const optMode = (opt as HTMLElement).dataset.navMode;
        opt.classList.toggle('active', optMode === mode);
      });

      if (currentNav) {
        currentNav.textContent = navModeNames[mode] || mode;
      }
    };

    // Apply typography preset
    const applyPreset = (btn: Element) => {
      const presetId = btn.getAttribute('data-preset-id');
      const fonts = JSON.parse(btn.getAttribute('data-fonts') || '{}');
      const colors = JSON.parse(btn.getAttribute('data-colors') || '{}');
      const styles = JSON.parse(btn.getAttribute('data-styles') || '{}');

      html.setAttribute('data-typography', presetId || '');
      html.style.setProperty('--font-body', `"${fonts.body}", Georgia, serif`);
      html.style.setProperty('--font-heading', `"${fonts.heading}", Georgia, serif`);
      html.style.setProperty('--font-ui', `"${fonts.ui}", system-ui, sans-serif`);
      html.style.setProperty('--font-mono', `"${fonts.mono}", monospace`);
      html.style.setProperty('--color-accent-light', colors.accentLight);
      html.style.setProperty('--color-accent-dark', colors.accentDark);
      html.style.setProperty('--heading-style', styles.headingStyle);
      html.style.setProperty('--heading-weight', styles.headingWeight);
      html.style.setProperty('--body-weight', styles.bodyWeight);

      localStorage.setItem('typography-preset', presetId || '');
      localStorage.setItem('typography-fonts', JSON.stringify(fonts));
      localStorage.setItem('typography-colors', JSON.stringify(colors));
      localStorage.setItem('typography-styles', JSON.stringify(styles));

      typographyOptions.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      if (currentTypography) {
        currentTypography.textContent = btn.querySelector('.option-name')?.textContent || '-';
      }
    };

    // Apply theme (light/dark)
    const applyTheme = (theme: string) => {
      html.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);

      themeOptions.forEach(opt => {
        const optTheme = (opt as HTMLElement).dataset.theme;
        opt.classList.toggle('active', optTheme === theme);
      });

      if (currentTheme) {
        currentTheme.textContent = theme === 'dark' ? 'Dark' : 'Light';
      }
    };

    // Get stored theme
    const getStoredTheme = () => {
      const stored = localStorage.getItem('theme');
      if (stored) return stored;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    // Initialize with stored values
    applyNavMode(getStoredNavMode());
    applyTheme(getStoredTheme());

    const storedPresetId = getStoredPreset();
    const storedPresetBtn = document.querySelector(`[data-preset-id="${storedPresetId}"]`);
    if (storedPresetBtn) {
      applyPreset(storedPresetBtn);
    }

    // Toggle dropdown
    toggle?.addEventListener('click', () => {
      const isHidden = dropdown?.hasAttribute('hidden');
      if (isHidden) {
        dropdown?.removeAttribute('hidden');
      } else {
        dropdown?.setAttribute('hidden', '');
      }
    });

    // Close dropdown
    close?.addEventListener('click', () => {
      dropdown?.setAttribute('hidden', '');
    });

    // Nav mode selection
    navOptions.forEach(opt => {
      opt.addEventListener('click', () => {
        const mode = (opt as HTMLElement).dataset.navMode;
        if (mode) applyNavMode(mode);
      });
    });

    // Typography selection
    typographyOptions.forEach(btn => {
      btn.addEventListener('click', () => applyPreset(btn));
    });

    // Theme selection
    themeOptions.forEach(opt => {
      opt.addEventListener('click', () => {
        const theme = (opt as HTMLElement).dataset.theme;
        if (theme) applyTheme(theme);
      });
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('settings-panel');
      if (panel && !panel.contains(e.target as Node)) {
        dropdown?.setAttribute('hidden', '');
      }
    });
  }

  // Initialize
  initSettingsPanel();
  document.addEventListener('astro:after-swap', initSettingsPanel);
</script>
